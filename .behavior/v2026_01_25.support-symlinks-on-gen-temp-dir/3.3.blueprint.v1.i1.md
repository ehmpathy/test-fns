# blueprint: genTempDir symlink support

## overview

extend `genTempDir` to accept an optional `symlink` array that creates symlinks from temp dir paths to repo root paths.

```ts
genTempDir({
  slug: 'my-test',
  clone: './fixtures/example',  // optional, as before
  symlink: [                    // new optional parameter
    { at: 'config/settings.json', to: 'src/config/defaults.json' },
    { at: 'node_modules', to: 'node_modules' },
  ],
});
```

---

## filediff treestruct

```
[~] readme.md                              # add symlink documentation
src/
  infra/
    isomorph.fs/
      [+] createSymlinks.ts              # new infra utility
      [+] createSymlinks.test.ts         # unit tests for createSymlinks
  domain.operations/
    genTempDir/
      [~] genTempDir.ts                  # extend input signature
      [~] genTempDir.jest.test.ts        # add unit tests for symlink validation
      [~] genTempDir.integration.jest.test.ts  # add integration tests
```

---

## codepath treestruct

```
genTempDir({ slug, clone?, symlink? })
  │
  ├─► getGitRoot()                         # [REUSE] get repo root
  │
  ├─► ensureTempDir({ gitRoot })           # [REUSE] ensure .temp exists
  │
  ├─► computeTempDirName({ slug })         # [REUSE] generate unique name
  │
  ├─► fs.mkdirSync(tempDir)                # [REUSE] create temp dir
  │
  ├─► pruneStaleOnce({ tmpDir })           # [REUSE] background cleanup
  │
  ├─► if (clone) cloneFixture(...)         # [REUSE] clone fixture
  │
  └─► if (symlink) createSymlinks(...)     # [NEW] create symlinks
        │
        ├─► validate all targets exist     # fail-fast before any creation
        │     └─► BadRequestError if absent
        │
        ├─► validate no path collisions    # check against cloned content
        │     └─► BadRequestError if collision
        │
        └─► for each { at, to }:
              ├─► ensure parent dirs exist
              └─► fs.symlinkSync(target, path)
```

---

## contracts

### genTempDir input (extended)

```ts
type SymlinkEntry = {
  at: string;  // relative path within temp dir
  to: string;  // relative path within repo root
};

type GenTempDirInput = {
  slug: string;
  clone?: string;
  symlink?: SymlinkEntry[];
};
```

### createSymlinks input

```ts
type CreateSymlinksInput = {
  symlinks: SymlinkEntry[];
  tempDir: string;   // absolute path to temp dir
  gitRoot: string;   // absolute path to repo root
};
```

---

## domain decomposition

### infra layer: `createSymlinks`

**file:** `src/infra/isomorph.fs/createSymlinks.ts`

**responsibility:**
- validate all symlink targets exist (fail-fast)
- validate no path collisions with cloned content
- create parent directories as needed
- create symlinks via `fs.symlinkSync`

**contract:**
```ts
/**
 * .what = creates symlinks from temp dir paths to repo root paths
 * .why = enables test temp dirs to reference repo root artifacts without copy
 *
 * @throws BadRequestError when symlink target does not exist
 * @throws BadRequestError when symlink path collides with cloned content
 */
export const createSymlinks = (input: {
  symlinks: Array<{ at: string; to: string }>;
  tempDir: string;
  gitRoot: string;
}): void
```

### domain layer: `genTempDir` (extended)

**file:** `src/domain.operations/genTempDir/genTempDir.ts`

**changes:**
1. extend input type to accept `symlink?: Array<{ at: string; to: string }>`
2. after clone (if any), call `createSymlinks` if symlink array provided
3. pass `gitRoot` to `createSymlinks` for target resolution

---

## execution order

```
1. getGitRoot()           # resolve repo root
2. ensureTempDir()        # ensure .temp exists
3. computeTempDirName()   # generate unique name
4. fs.mkdirSync()         # create temp directory
5. pruneStaleOnce()       # background cleanup (fire-and-forget)
6. cloneFixture()         # if clone specified
7. createSymlinks()       # if symlink specified (after clone)
8. return tempDir
```

symlinks are created **after** clone to ensure:
- symlinks can augment cloned content
- collision detection works against final cloned state

---

## error semantics

| condition | error type | message pattern |
|-----------|------------|-----------------|
| symlink target absent | `BadRequestError` | `symlink target not found: {repoRoot}/{to}` |
| symlink path collision | `BadRequestError` | `symlink path collides with cloned content: {at}` |

all symlink targets are validated **before** any symlinks are created (all-or-none semantics).

---

## test coverage

### unit tests: `createSymlinks.test.ts`

```
given('createSymlinks is called')
  when('all symlink targets exist')
    then('symlinks are created at specified paths')
    then('symlinks point to correct targets')

  when('symlink `at` includes nested directories')
    then('parent directories are created')

  when('symlink target does not exist')
    then('throws BadRequestError with target path')

  when('symlink path collides with cloned file')
    then('throws BadRequestError with collision path')

  when('multiple symlinks specified')
    then('all symlinks are created')

  when('one symlink has invalid target')
    then('no symlinks are created (all-or-none)')
```

### integration tests: `genTempDir.integration.jest.test.ts` (extended)

```
given('genTempDir is called with symlink option')
  when('symlink targets exist in repo root')
    then('temp dir contains symlinks at specified paths')
    then('symlinks resolve to repo root files')
    then('symlinked files are readable')

  when('symlink points to a directory')
    then('directory symlink is created')
    then('directory contents are accessible via symlink')

  when('both clone and symlink are specified')
    then('cloned files exist')
    then('symlinks exist alongside cloned files')

  when('symlink target does not exist')
    then('throws error with clear message')
    then('temp dir is still created (but empty or with clone only)')
```

### acceptance tests: blackbox behavior verification

```
given('genTempDir with symlink option')
  when('valid symlinks specified')
    then('symlink at {tempDir}/{at} exists')
    then('symlink points to {repoRoot}/{to}')
    then('file content accessible via symlink matches original')
```

---

## documentation: readme.md

add symlink usage to the genTempDir section of readme.md:

```md
### with symlinks to repo root

```ts
// create temp dir with symlinks to repo root files
const dir = genTempDir({
  slug: 'symlink-test',
  symlink: [
    { at: 'config/settings.json', to: 'src/config/defaults.json' },
    { at: 'node_modules', to: 'node_modules' },
  ],
});
// => dir contains symlinks:
//    config/settings.json -> {repoRoot}/src/config/defaults.json
//    node_modules -> {repoRoot}/node_modules
```

**symlink options:**
- `at` = relative path within the temp dir (where symlink is created)
- `to` = relative path within the repo root (what symlink points to)

**notes:**
- symlinks are created after clone (if both specified)
- parent directories are created automatically
- throws `BadRequestError` if target does not exist
```

---

## implementation steps

1. **create `createSymlinks.ts`** — infra utility with validation and symlink creation
2. **create `createSymlinks.test.ts`** — unit tests for the new utility
3. **extend `genTempDir.ts`** — add symlink parameter and call createSymlinks
4. **extend `genTempDir.integration.jest.test.ts`** — add integration tests
5. **update `readme.md`** — add symlink documentation to genTempDir section
6. **verify all tests pass** — `npm run test:unit && npm run test:integration`

---

## maintenance notes

- symlink paths use forward slashes on all platforms (node normalizes)
- symlink type is auto-detected by node (`file` vs `dir`)
- no new exports needed — `genTempDir` signature extends in place
- `createSymlinks` is internal to infra layer, not exported from contract
