# roadmap: genTempDir

## prereqs

before any phase, read:
- `.behavior/v2026_01_19.gen-temp-dir/0.wish.md` — understand the goal
- `.behavior/v2026_01_19.gen-temp-dir/3.3.blueprint.v1.i1.md` — understand the architecture


---

## phase 0: pure logic

**prereqs to read:**
- (none — pure functions have no external dependencies)

**goal:** implement pure functions that can be unit tested without filesystem access


### step 0.1: computeTempDirName

- [ ] **create** `src/domain.operations/genTempDir/computeTempDirName.ts`
- [ ] **create** `src/domain.operations/genTempDir/computeTempDirName.vitest.test.ts`

**acceptance criteria:**
- returns string in format `{isoTimestamp}.{shortUuid}`
- timestamp is valid iso format (parseable by `new Date()`)
- uuid suffix is 8 hex characters
- two consecutive calls return different values

**verification:**
```sh
npm run test:unit -- computeTempDirName
```

**expected output:**
```
✓ returns a string with iso timestamp prefix
✓ timestamp is parseable as a date
✓ includes 8-char uuid suffix
✓ returns unique value on each call
```


### step 0.2: computeStaleDirs

- [ ] **depends on:** step 0.1 (for DirEntry type definition)
- [ ] **create** `src/domain.operations/genTempDir/computeStaleDirs.ts`
- [ ] **create** `src/domain.operations/genTempDir/computeStaleDirs.vitest.test.ts`

**acceptance criteria:**
- empty input returns empty output
- filters out dirs with timestamp older than maxAgeMs
- preserves dirs with timestamp newer than maxAgeMs
- handles malformed dir names gracefully (skips them)

**verification:**
```sh
npm run test:unit -- computeStaleDirs
```

**expected output:**
```
✓ returns empty array for empty input
✓ filters dirs older than threshold
✓ preserves dirs newer than threshold
✓ skips dirs with invalid timestamp format
```


---

## phase 1: infra layer

**prereqs to read:**
- (none — infra functions are low-level filesystem utilities)

**goal:** implement filesystem utilities that can be integration tested


### step 1.1: getGitRoot

- [ ] **create** `src/infra/isomorph.fs/getGitRoot.ts`

**acceptance criteria:**
- returns absolute path to git repo root
- works when called from nested subdirectory
- throws clear error when not in a git repo

**verification:**
```sh
# manual verification (no test file for infra — tested via integration tests in phase 2)
node -e "const { getGitRoot } = require('./dist/infra/isomorph.fs/getGitRoot'); console.log(getGitRoot())"
```

**expected output:**
```
/path/to/test-fns
```


### step 1.2: ensureTempDir

- [ ] **depends on:** step 1.1 (uses getGitRoot)
- [ ] **create** `src/infra/isomorph.fs/ensureTempDir.ts`

**acceptance criteria:**
- creates `{gitRoot}/.tmp` if it does not exist
- creates `{gitRoot}/.tmp/readme.md` with ttl policy explanation if absent
- returns path to `.tmp` directory
- idempotent — repeat calls have no additional effect

**verification:**
```sh
# manual verification
node -e "const { ensureTempDir } = require('./dist/infra/isomorph.fs/ensureTempDir'); console.log(ensureTempDir({ gitRoot: process.cwd() }))"
ls -la .tmp/
cat .tmp/readme.md
```

**expected output:**
```
/path/to/test-fns/.tmp
# .tmp directory exists with readme.md
```


### step 1.3: cloneFixture

- [ ] **create** `src/infra/isomorph.fs/cloneFixture.ts`

**acceptance criteria:**
- copies all files from source to destination recursively
- preserves symlinks as symlinks (not resolved)
- throws clear error if source path does not exist
- destination directory is created if absent

**verification:**
```sh
# manual verification with test fixture
mkdir -p /tmp/test-fixture/nested && echo "test" > /tmp/test-fixture/file.txt && echo "nested" > /tmp/test-fixture/nested/deep.txt
node -e "const { cloneFixture } = require('./dist/infra/isomorph.fs/cloneFixture'); cloneFixture({ from: '/tmp/test-fixture', to: '/tmp/test-clone' })"
find /tmp/test-clone -type f
```

**expected output:**
```
/tmp/test-clone/file.txt
/tmp/test-clone/nested/deep.txt
```


---

## phase 2: domain operations

**prereqs to read:**
- `.behavior/v2026_01_19.gen-temp-dir/2.criteria.blackbox.md` — understand experience bounds

**goal:** implement domain operations with integration tests


### step 2.1: pruneStale + pruneStaleOnce

- [ ] **depends on:** step 0.2 (computeStaleDirs), step 1.2 (ensureTempDir)
- [ ] **create** `src/domain.operations/genTempDir/pruneStale.ts`
- [ ] **create** `src/domain.operations/genTempDir/pruneStale.integration.vitest.test.ts`

**acceptance criteria (pruneStale):**
- lists directories in tmpDir
- removes directories older than maxAgeMs (default 1hr)
- preserves directories newer than maxAgeMs
- runs asynchronously (fire-and-forget pattern)
- does not throw on empty tmpDir

**acceptance criteria (pruneStaleOnce):**
- calls pruneStale at most once per process
- subsequent calls are no-ops (return immediately)
- uses in-memory global flag for throttle

**verification:**
```sh
npm run test:integration -- pruneStale
```

**expected output:**
```
✓ removes directories older than threshold
✓ preserves directories newer than threshold
✓ handles empty tmpDir gracefully
✓ completes without block
✓ pruneStaleOnce only prunes once per process
```


### step 2.2: genTempDir + isTempDir

- [ ] **depends on:** step 0.1, step 1.1, step 1.2, step 1.3, step 2.1
- [ ] **create** `src/domain.operations/genTempDir/genTempDir.ts`
- [ ] **create** `src/domain.operations/genTempDir/genTempDir.vitest.test.ts`
- [ ] **create** `src/domain.operations/genTempDir/genTempDir.integration.vitest.test.ts`

**acceptance criteria (genTempDir):**
- returns absolute path to new directory
- directory exists on filesystem after call
- directory is empty (when no clone option)
- directory path contains timestamp prefix
- multiple calls return unique paths
- triggers pruneStaleOnce (max one prune per process)

**acceptance criteria (genTempDir with clone):**
- copies fixture contents to new directory
- original fixture is unchanged
- throws clear error if fixture path does not exist

**acceptance criteria (isTempDir):**
- returns true for paths that match test dir pattern
- returns false for paths that do not match

**verification:**
```sh
npm run test:unit -- genTempDir.vitest.test
npm run test:integration -- genTempDir.integration
```

**expected output:**
```
# unit tests
✓ isTempDir returns true for valid test dir paths
✓ isTempDir returns false for invalid paths

# integration tests
✓ creates empty directory
✓ returns absolute path
✓ path contains timestamp prefix
✓ multiple calls return unique paths
✓ with clone: copies fixture contents
✓ with clone: throws on absent fixture
```


---

## phase 3: contract + docs

**prereqs to read:**
- `.behavior/v2026_01_19.gen-temp-dir/2.criteria.blackbox.md` — acceptance test cases

**goal:** export public api and document the feature


### step 3.1: contract export

- [ ] **depends on:** step 2.2
- [ ] **update** `src/contract/index.ts` — add genTempDir, isTempDir exports

**acceptance criteria:**
- `genTempDir` is importable from `test-fns`
- `isTempDir` is importable from `test-fns`
- typescript types are correct

**verification:**
```sh
npm run build
node -e "const { genTempDir, isTempDir } = require('./dist'); console.log(typeof genTempDir, typeof isTempDir)"
```

**expected output:**
```
function function
```


### step 3.2: acceptance tests

- [ ] **depends on:** step 3.1
- [ ] **create** `src/domain.operations/genTempDir/genTempDir.acceptance.vitest.test.ts`

**acceptance criteria (from blackbox criteria):**

usecase.1 — generate ephemeral test directory:
- [ ] returns absolute path to new directory
- [ ] directory exists on filesystem
- [ ] directory is empty
- [ ] path contains timestamp prefix
- [ ] multiple calls return unique paths

usecase.2 — generate from fixture:
- [ ] copies fixture contents
- [ ] original fixture unchanged
- [ ] throws on absent fixture

usecase.3 — automatic cleanup:
- [ ] stale dirs (>1hr) are pruned
- [ ] recent dirs are preserved
- [ ] prune does not block

boundary.1 — edge cases:
- [ ] creates .tmp if absent
- [ ] creates readme.md in .tmp
- [ ] copies nested directories
- [ ] preserves symlinks

**verification:**
```sh
npm run test:acceptance -- genTempDir
```

**expected output:**
```
✓ usecase.1: generate ephemeral test directory
✓ usecase.2: generate from fixture
✓ usecase.3: automatic cleanup
✓ boundary.1: edge cases
```


### step 3.3: readme documentation

- [ ] **depends on:** step 3.2 (tests pass first)
- [ ] **update** `readme.md` — add genTempDir section after "hooks"

**acceptance criteria:**
- genTempDir feature is documented
- basic usage example is provided
- fixture clone example is provided
- cleanup behavior is explained
- jsdoc comments match readme content

**verification:**
```sh
# manual review
grep -A 50 "### genTempDir" readme.md
```


---

## phase 4: validation

**prereqs to read:**
- `.behavior/v2026_01_19.gen-temp-dir/2.criteria.blackbox.md` — verify all criteria met

**goal:** full validation across test suite and platforms


### step 4.1: full test suite

- [ ] **depends on:** all previous steps
- [ ] run all tests locally

**verification:**
```sh
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
npm run test:acceptance
```

**expected output:**
```
✓ all type checks pass
✓ all lint checks pass
✓ all unit tests pass
✓ all integration tests pass
✓ all acceptance tests pass
```


### step 4.2: ci validation

- [ ] **depends on:** step 4.1
- [ ] push to branch
- [ ] verify ci passes on ubuntu
- [ ] verify ci passes on macos (if ci matrix includes macos)

**verification:**
```sh
git push origin HEAD
gh pr checks
```

**expected output:**
```
✓ ci_on_commit — ubuntu: pass
✓ ci_on_commit — macos: pass (if applicable)
```


---

## completion checklist

all criteria from `2.criteria.blackbox.md` verified:

- [ ] **usecase.1** — ephemeral test directory generation
- [ ] **usecase.2** — fixture clone
- [ ] **usecase.3** — automatic cleanup
- [ ] **usecase.4** — cross-platform portability
- [ ] **usecase.5** — discoverability and documentation
- [ ] **boundary.1** — edge cases
