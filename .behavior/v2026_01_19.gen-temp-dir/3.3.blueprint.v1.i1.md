# blueprint: genTempDir

## summary

portable test directory generation with automatic cleanup, via in-repo `.tmp` with timestamp-prefixed dirs and background prune of stale entries (>1hr).


---

## treestruct: filediffs

```
src/
  domain.operations/
    genTempDir/
      [+] genTempDir.ts                                  # main generator + isTempDir validator
      [+] genTempDir.vitest.test.ts                      # unit tests
      [+] genTempDir.integration.vitest.test.ts          # integration tests (filesystem)
      [+] genTempDir.acceptance.vitest.test.ts           # acceptance tests (blackbox)
      [+] computeTempDirName.ts                          # pure: timestamp + uuid suffix
      [+] computeTempDirName.vitest.test.ts              # unit tests
      [+] computeStaleDirs.ts                            # pure: filter dirs by age threshold
      [+] computeStaleDirs.vitest.test.ts                # unit tests
      [+] pruneStale.ts                                  # remove stale dirs in background
      [+] pruneStale.integration.vitest.test.ts          # integration tests
  infra/
    isomorph.fs/
      [+] getGitRoot.ts                                  # find git repo root (sync)
      [+] ensureTempDir.ts                                # create .tmp + readme if absent
      [+] cloneFixture.ts                                # recursive copy with symlink preserve
  contract/
    [~] index.ts                                         # add genTempDir export
  [~] readme.md                                          # document genTempDir feature
```

**note:** vitest only — no jest tests needed for this feature


---

## treestruct: codepaths

```
genTempDir(input?)                              # domain.operations/genTempDir/
│
├─ [sync] getGitRoot()                          # infra/isomorph.fs/
│   └─ walks up from cwd to find .git directory
│
├─ [sync] ensureTempDir({ gitRoot })             # infra/isomorph.fs/
│   ├─ creates {gitRoot}/.tmp if absent
│   └─ writes readme.md with ttl policy if absent
│
├─ [sync] computeTempDirName()                  # domain.operations/genTempDir/
│   └─ returns "{isoTimestamp}.{shortUuid}"
│
├─ [sync] fs.mkdirSync({ path: {gitRoot}/.tmp/{dirName} })
│
├─ [async background] pruneStaleOnce({ tmpDir })  # domain.operations/genTempDir/
│   ├─ check global cache: if already pruned this process, skip
│   ├─ set global cache flag
│   ├─ lists dirs in .tmp
│   ├─ computeStaleDirs({ dirs, maxAgeMs })       # domain.operations/genTempDir/
│   └─ removes each stale dir
│
├─ [conditional] if input.clone
│   └─ cloneFixture({ from, to })               # infra/isomorph.fs/
│       ├─ validates fixture exists
│       └─ recursive copy with symlinks preserved
│
└─ return dirPath (absolute)
```


---

## domain decomposition

### domain.operations/genTempDir/

| function | type | signature | responsibility |
|----------|------|-----------|----------------|
| `genTempDir` | orchestrator | `(input?: { clone?: string }) => string` | main entry: orchestrate dir creation + prune + optional clone |
| `isTempDir` | validator | `(path: string) => boolean` | check if path matches test dir pattern |
| `computeTempDirName` | pure | `() => string` | generate `{isoTimestamp}.{shortUuid}` |
| `computeStaleDirs` | pure | `(input: { dirs: DirEntry[], maxAgeMs: number }) => DirEntry[]` | filter dirs older than threshold |
| `pruneStale` | async | `(input: { tmpDir: string, maxAgeMs?: number }) => Promise<void>` | remove stale dirs |
| `pruneStaleOnce` | async | `(input: { tmpDir: string }) => Promise<void>` | throttled wrapper: max one prune per process |

### infra/isomorph.fs/

| function | signature | responsibility |
|----------|-----------|----------------|
| `getGitRoot` | `() => string` | find git repo root from cwd |
| `ensureTempDir` | `(input: { gitRoot: string }) => string` | create .tmp + readme if absent |
| `cloneFixture` | `(input: { from: string, to: string }) => void` | recursive copy with symlink preserve |


---

## contracts

### public api

```ts
/**
 * generates a temporary test directory within the repo's .tmp folder
 *
 * @example
 * // basic usage - empty dir
 * const dir = genTempDir();
 * // => /path/to/repo/.tmp/2026-01-19T12-34-56.789Z.a1b2c3d4
 *
 * @example
 * // with fixture clone
 * const dir = genTempDir({ clone: './src/__fixtures__/example' });
 * // => dir contains copy of fixture contents
 *
 * @note
 * - directories are auto-pruned after 1 hour
 * - timestamp prefix enables age-based cleanup without stat calls
 * - safe on macos and ubuntu without os-specific temp dir dependencies
 */
export const genTempDir: (input?: { clone?: string }) => string;

/**
 * checks if a path is a test directory created by genTempDir
 *
 * @example
 * isTempDir('/repo/.tmp/2026-01-19T12-34-56.789Z.a1b2c3d4'); // true
 * isTempDir('/tmp/random'); // false
 */
export const isTempDir: (path: string) => boolean;
```

### internal types

```ts
interface DirEntry {
  name: string;       // directory name
  path: string;       // absolute path
  timestamp: Date;    // parsed from name prefix
}
```

### global state

```ts
/**
 * in-memory flag to ensure prune runs at most once per process
 *
 * why: prevents redundant filesystem scans when genTempDir is called
 * many times in quick succession (e.g., parallel tests)
 */
let prunedThisProcess = false;
```


---

## test coverage

### unit tests (domain.operations/genTempDir/)

| target | cases |
|--------|-------|
| `computeTempDirName` | returns valid iso timestamp prefix, includes unique suffix, unique across calls |
| `computeStaleDirs` | empty list returns empty, filters by age threshold, preserves recent dirs |
| `isTempDir` | matches valid patterns, rejects invalid paths |

### integration tests (infra/isomorph.fs/)

| target | cases |
|--------|-------|
| `getGitRoot` | finds root from nested dir, throws outside git repo |
| `ensureTempDir` | creates .tmp if absent, creates readme.md if absent, idempotent on repeat |
| `cloneFixture` | copies files recursively, preserves symlinks, throws on absent fixture |

### integration tests (domain.operations/genTempDir/)

| target | cases |
|--------|-------|
| `pruneStale` | removes dirs older than threshold, preserves recent dirs |
| `genTempDir` | creates empty dir, returns absolute path, path contains timestamp, unique per call |
| `genTempDir({ clone })` | copies fixture contents, throws on absent fixture |

### acceptance tests (blackbox via contract — `genTempDir.acceptance.vitest.test.ts`)

| scenario | verification |
|----------|--------------|
| basic generation | `genTempDir()` returns path that exists and is empty |
| fixture clone | `genTempDir({ clone })` returns path with fixture contents |
| parallel calls | multiple `genTempDir()` calls return unique paths |
| cross-platform | works on both macos and ubuntu (ci matrix) |
| auto-prune | stale dirs (>1hr) are removed on next `genTempDir()` call |


---

## readme documentation

add section after "hooks":

```markdown
## utilities

### genTempDir

generates a temporary test directory within the repo's `.tmp` folder, with automatic cleanup of stale directories.

**features:**
- portable across macos and ubuntu (no os-specific temp dir dependencies)
- timestamp-prefixed names enable age-based cleanup
- auto-prunes directories older than 1 hour
- optional fixture clone for pre-populated test scenarios

**basic usage:**

\`\`\`ts
import { genTempDir } from 'test-fns';

describe('file processor', () => {
  given('a test directory', () => {
    const testDir = genTempDir();

    when('files are written', () => {
      then('they exist in the test directory', async () => {
        await fs.writeFile(path.join(testDir, 'example.txt'), 'content');
        expect(await fs.stat(path.join(testDir, 'example.txt'))).toBeDefined();
      });
    });
  });
});
\`\`\`

**with fixture clone:**

\`\`\`ts
import { genTempDir } from 'test-fns';

describe('config parser', () => {
  given('a directory with config files', () => {
    const testDir = genTempDir({ clone: './src/__fixtures__/configs' });

    when('config is loaded', () => {
      then('it parses correctly', async () => {
        const config = await loadConfig(testDir);
        expect(config.configOption).toEqual('value');
      });
    });
  });
});
\`\`\`

**cleanup behavior:**

directories in `.tmp` are automatically pruned when:
- they are older than 1 hour (based on timestamp prefix)
- `genTempDir()` is called (prune runs in background)

the `.tmp` directory includes a `readme.md` that explains the ttl policy.
```


---

## execution phases

### phase 0: pure logic (unit testable)
1. create `src/domain.operations/genTempDir/computeTempDirName.ts` + unit tests
2. create `src/domain.operations/genTempDir/computeStaleDirs.ts` + unit tests

### phase 1: infra layer (integration testable)
1. create `src/infra/isomorph.fs/getGitRoot.ts`
2. create `src/infra/isomorph.fs/ensureTempDir.ts`
3. create `src/infra/isomorph.fs/cloneFixture.ts`
4. add integration tests for each

### phase 2: domain operations (integration testable)
1. create `src/domain.operations/genTempDir/pruneStale.ts` + integration tests
2. create `src/domain.operations/genTempDir/genTempDir.ts` (orchestrator + isTempDir)
3. add unit tests + integration tests

### phase 3: contract + docs
1. update `src/contract/index.ts` with exports
2. create `src/domain.operations/genTempDir/genTempDir.acceptance.vitest.test.ts`
3. update `readme.md` with documentation

### phase 4: validation
1. run full test suite
2. verify on ubuntu ci
3. verify on macos ci


---

## risks and mitigations

| risk | mitigation |
|------|------------|
| prune race condition | use timestamp from dir name, not stat; fire-and-forget pattern |
| git root not found | throw clear error with cwd context |
| fixture symlink loops | use native fs.cp with recursive + verbatimSymlinks |
| ci parallel test collision | uuid suffix ensures uniqueness even with same timestamp |
