# blackbox criteria: isolated temp dir

## usecase.1 = generate an isolated temp directory

given('a test that needs a temporary directory')
  when('genTempDir is called with { slug }')
    then('returns the link path (within @gitroot/.temp/genTempDir.symlink/)')
      sothat('logs show a familiar, navigable location')
    then('the directory exists on the filesystem')
    then('the directory is empty')
    then('the directory path contains a timestamp prefix')
      sothat('age-based cleanup can occur without stat calls')
    then('the directory path contains the slug for debug')
      sothat('debuggers can identify which test created the directory')

  when('genTempDir is called multiple times in quick succession')
    then('each call returns a unique directory path')
      sothat('concurrent tests dont collide')


## usecase.2 = isolation from gitroot module resolution

given('a temp directory created by genTempDir')
  then('physical files are stored at /tmp/test-fns/{repo-dirname}/.temp/')
    sothat('temp dirs are isolated from any repo with node_modules or package.json')

  when('a process searches upward for node_modules from within the temp dir')
    then('no node_modules is found in any ancestor directory')
      sothat('temp repos cannot accidentally import from gitroot dependencies')

  when('a process searches upward for package.json from within the temp dir')
    then('no package.json is found in any ancestor directory')
      sothat('temp repos cannot accidentally inherit gitroot config')

  when('genTempDir runs on ci (clean environment, no node_modules at gitroot)')
    then('behavior is identical to local (where gitroot may have node_modules)')
      sothat('tests are portable between ci and local development')


## usecase.3 = discoverability via symlink at gitroot

given('a temp directory created by genTempDir')
  when('user navigates to @gitroot/.temp/genTempDir.symlink/')
    then('a symlink exists that references the actual temp location')
      sothat('users can easily discover and observe temp dirs')
    then('the symlink target path is within /tmp/')
      sothat('no ancestors contain node_modules or package.json')

  when('user lists contents of @gitroot/.temp/genTempDir.symlink/')
    then('they see temp dir entries (via symlink resolution)')
      sothat('standard directory navigation works as expected')


## usecase.4 = generate temp directory from fixture

given('a test that needs a pre-populated directory')
  when('genTempDir is called with { slug, clone: "path/to/fixture" }')
    then('returns the link path (within @gitroot/.temp/genTempDir.symlink/)')
    then('the directory contains a copy of all files from the fixture path')
    then('the original fixture directory is unchanged')
      sothat('clone is non-destructive')

  when('genTempDir is called with a clone path that does not exist')
    then('throws a clear error that indicates the fixture path was not found')


## usecase.5 = symlink support within temp directories

given('a test that needs symlinks to repo resources')
  when('genTempDir is called with { slug, symlink: [...] }')
    then('the temp dir contains symlinks that point to specified gitroot paths')
      sothat('tests can reference repo resources without copy')
    then('symlinks work correctly from the isolated /tmp/ location')
      sothat('isolation does not break symlink functionality')


## usecase.6 = automatic cleanup of stale temp directories

given('temp directories older than 7 days exist')
  when('genTempDir is called')
    then('stale directories are automatically pruned in the background')
      sothat('disk space is reclaimed without manual intervention')

  when('temp directories younger than 7 days exist')
    then('those directories are not pruned')
      sothat('active test directories are preserved')


## boundary.1 = first-time setup

given('the temp infrastructure does not yet exist')
  when('genTempDir is called for the first time')
    then('the /tmp/test-fns/{repo-dirname}/.temp/ structure is created automatically')
    then('the @gitroot/.temp/genTempDir.symlink symlink is created automatically')
      sothat('the name is self-descriptive: it is a symlink, created by genTempDir')
    then('a readme.md is placed within genTempDir.symlink/ that explains the ttl policy')
    then('a .gitignore is placed within genTempDir.symlink/ that ignores all temp dir contents')

given('/tmp/ does not exist on the machine')
  when('genTempDir is called')
    then('throws a clear error that /tmp/ is required')
      sothat('we fail fast on non-unix or misconfigured systems')


## boundary.2 = nested fixtures

given('a fixture directory with deeply nested subdirectories')
  when('genTempDir is called with { slug, clone: "path/to/nested/fixture" }')
    then('all nested files and directories are copied recursively')


## boundary.3 = concurrent usage

given('multiple processes or test suites that run simultaneously')
  when('each calls genTempDir')
    then('no race conditions occur on setup or cleanup')
    then('each receives a unique, isolated temp directory')
