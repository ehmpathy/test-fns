# blueprint: isolated temp dir

## summary

store physical temp directories in `/tmp/test-fns/{repo-dirname}/.temp/` with a symlink at `@gitroot/.temp/genTempDir.symlink/` for discoverability. this isolates temp dirs from gitroot's `node_modules` and `package.json` in upward search.

**note**: this is a forward-only change. no migration of prior temp directories — they are ephemeral by design and safe to discard.

**paths**:
- physical: `/tmp/test-fns/{repo-dirname}/.temp/`
- symlink: `@gitroot/.temp/genTempDir.symlink/` → physical
- return: `@gitroot/.temp/genTempDir.symlink/{tempDirName}`

---

## filediff treestruct

```
src/
├── infra/
│   └── isomorph.fs/
│       ├── [+] computeIsolatedTempBasePath.ts
│       ├── [+] computeIsolatedTempBasePath.jest.test.ts
│       ├── [+] genIsolatedTempInfra.ts
│       ├── [+] genIsolatedTempInfra.integration.jest.test.ts
│       ├── [-] ensureTempDir.ts                    # remove (unused after refactor)
│       └── [○] createSymlinks.ts                   # no change needed (already uses absolute paths)
├── domain.operations/
│   └── genTempDir/
│       ├── [~] genTempDir.ts                       # use new infra, return link path
│       ├── [→] genEphemeralTempDir.ts              # eject ephemeral dir logic for reuse
│       ├── [+] genEphemeralTempDir.integration.jest.test.ts # test ejected logic
│       ├── [~] genTempDir.integration.jest.test.ts # update for symlink behavior
│       ├── [~] genTempDir.acceptance.jest.test.ts  # add isolation tests
│       └── [~] pruneStale.ts                       # prune from physical /tmp/ location
```

---

## codepath treestruct

**legend:**
- `[+]` create — codepath to create
- `[~]` update — codepath to update
- `[○]` retain — codepath to retain
- `[-]` delete — codepath to delete
- `[←]` reuse — codepath to reuse from elsewhere
- `[→]` eject — codepath to decompose for reuse

```
[~] genTempDir({ slug, clone?, symlink? })
│
├── [○] getGitRoot()
│   └── returns: /path/to/repo
│
├── [+] genIsolatedTempInfra({ gitRoot })
│   │
│   ├── [+] computeIsolatedTempBasePath({ gitRoot })
│   │   └── returns: /tmp/test-fns/{repo-dirname}/.temp
│   │
│   ├── [+] validate /tmp/ exists
│   │   └── throw if absent: "genTempDir requires /tmp/ directory (unix systems only)"
│   │
│   ├── [←] ensure @gitroot/.temp/ dir exists
│   │   └── create if absent
│   │
│   ├── [+] ensure physical dir: /tmp/test-fns/{repo-dirname}/.temp/
│   │   ├── create if absent
│   │   ├── write readme.md if absent (visible via symlink)
│   │   └── write .gitignore if absent (visible via symlink)
│   │
│   ├── [+] ensure symlink: @gitroot/.temp/genTempDir.symlink → /tmp/test-fns/{repo-dirname}/.temp
│   │   ├── if absent: create symlink
│   │   ├── if symlink found: verify target matches, update if stale
│   │   └── if directory found: remove it, create symlink (contents ephemeral)
│   │
│   └── returns: { pathPhysical, pathSymlink }
│
├── [~] pruneStaleOnce({ tmpDir: pathPhysical })
│   └── background prune of stale dirs in /tmp/
│
├── [→] genEphemeralTempDir({ slug, clone?, symlink?, tempInfra: { pathPhysical }, gitRoot })
│   │
│   ├── [○] computeTempDirName({ slug })
│   │   └── returns: 2026-01-25T12-34-56.789Z.{slug}.{8-hex}
│   │
│   ├── [~] create temp dir at physical path
│   │   └── fs.mkdirSync(pathPhysical + dirName)
│   │
│   ├── [○] cloneFixture (if clone specified)
│   │   └── copy to physical path
│   │
│   ├── [○] createSymlinks (if symlink specified)
│   │   └── create in physical temp dir, point to gitRoot
│   │
│   └── returns: dirName
│       └── e.g., 2026-01-25T12-34-56.789Z.my-test.a1b2c3d4
│
├── [-] ensureTempDir({ gitRoot })
│   └── replaced by genIsolatedTempInfra
│
└── return pathSymlink + dirName
    └── e.g., /path/to/repo/.temp/genTempDir.symlink/2026-01-25T12-34-56.789Z.my-test.a1b2c3d4
```

---

## contracts

### computeIsolatedTempBasePath

```ts
/**
 * .what = computes the isolated temp base path in /tmp/
 * .why = provides consistent location outside of any repo's module resolution
 */
export const computeIsolatedTempBasePath = (input: {
  gitRoot: string;
}): string => {
  // returns: /tmp/test-fns/{repo-dirname}/.temp
};
```

### genIsolatedTempInfra

```ts
/**
 * .what = ensures the isolated temp infrastructure exists
 * .why = creates physical storage in /tmp/ with symlink at gitroot for discoverability
 *
 * @throws UnexpectedCodePathError if /tmp/ does not exist
 */
export const genIsolatedTempInfra = (input: {
  gitRoot: string;
}): { pathPhysical: string; pathSymlink: string } => {
  // 1. validate /tmp/ exists (fail fast)
  // 2. ensure @gitroot/.temp/ dir exists
  // 3. ensure /tmp/test-fns/{repo-dirname}/.temp/ exists with readme + gitignore
  // 4. ensure @gitroot/.temp/genTempDir.symlink is symlink to physical path
  // 5. return both paths
};
```

### genEphemeralTempDir

```ts
/**
 * .what = creates an ephemeral temp directory with optional fixture clone and symlinks
 * .why = encapsulates per-call temp dir creation logic for reuse
 *
 * @returns the temp dir name (caller composes full path)
 */
export const genEphemeralTempDir = (input: {
  slug: string;
  clone?: string;
  symlink?: Array<{ at: string; to: string }>;
  tempInfra: { pathPhysical: string };
  gitRoot: string;
}): string => {
  // 1. compute temp dir name from slug
  // 2. create temp dir at pathPhysical
  // 3. clone fixture if specified
  // 4. create symlinks if specified (in pathPhysical, point to gitRoot)
  // 5. return dirName
};
```

### genTempDir (updated)

```ts
/**
 * .what = generates a temporary directory isolated from gitroot module resolution
 * .why = provides portable temp directory creation with automatic cleanup
 *
 * @returns the link path (within @gitroot/.temp/genTempDir.symlink/) for observability
 */
export const genTempDir = (input: {
  slug: string;
  clone?: string;
  symlink?: Array<{ at: string; to: string }>;
}): string => {
  // returns link path, not physical path
};
```

---

## test coverage

### unit tests

| file                                       | coverage               |
| ------------------------------------------ | ---------------------- |
| `computeIsolatedTempBasePath.jest.test.ts` | path computation logic |
| `computeTempDirName.jest.test.ts`          | prior - no change      |
| `computeStaleDirs.jest.test.ts`            | prior - no change      |

### integration tests

| file                                              | coverage                                                  |
| ------------------------------------------------- | --------------------------------------------------------- |
| `genIsolatedTempInfra.integration.jest.test.ts`   | physical dir creation, symlink creation, /tmp/ validation |
| `genEphemeralTempDir.integration.jest.test.ts`    | dir creation, fixture clone, symlinks in physical path    |
| `genTempDir.integration.jest.test.ts`             | update for symlink behavior, link path return             |
| `pruneStale.integration.jest.test.ts`             | verify prunes from physical /tmp/ location                |
| `createSymlinks.jest.test.ts`                     | prior - verify works from /tmp/ location                  |

### acceptance tests

| file                                 | coverage                                                                       |
| ------------------------------------ | ------------------------------------------------------------------------------ |
| `genTempDir.acceptance.jest.test.ts` | add: isolation from node_modules, isolation from package.json, ci/local parity |

---

## acceptance test additions

```ts
// usecase.2: isolation from gitroot module resolution
given('[case5] a temp directory created by genTempDir')
  when('[t0] we check physical location')
    then('physical files are stored at /tmp/test-fns/{repo-dirname}/.temp/')

  when('[t1] we search upward for node_modules from within the temp dir')
    then('no node_modules is found in any ancestor directory')

  when('[t2] we search upward for package.json from within the temp dir')
    then('no package.json is found in any ancestor directory')

// usecase.3: discoverability via symlink
given('[case6] symlink at gitroot')
  when('[t0] we check @gitroot/.temp/genTempDir.symlink/')
    then('it is a symlink')
    then('symlink target is within /tmp/')

  when('[t1] we list contents via symlink')
    then('temp directories are visible')

// boundary.1: /tmp/ validation
given('[case7] /tmp/ does not exist')
  when('[t0] genTempDir is called')
    then('throws clear error about /tmp/ requirement')
```

---

## migration strategy

### forward-only change

this is a **forward-only change** — no migration of prior temp directories:
- temp dirs are ephemeral by design (7-day ttl)
- safe to discard any prior contents
- callers should not rely on temp dir persistence across upgrades

### backward compatibility

the change is **transparent** to callers:
- api signature unchanged
- return value is still an absolute path within `@gitroot/.temp/genTempDir.symlink/`
- all prior operations (clone, symlink, prune) continue to work

### edge case: prior .temp directory found

if `@gitroot/.temp/genTempDir.symlink/` is a real directory (not symlink):
1. remove it (contents are ephemeral, safe to discard)
2. create the new `/tmp/test-fns/{repo}/.temp/` structure
3. create symlink at `@gitroot/.temp/genTempDir.symlink/` to the new location

---

## key design decisions

### 1. return link path, not physical path

**rationale**: observability. logs show `@gitroot/.temp/genTempDir.symlink/...` which users can easily navigate to. the symlink transparently resolves to the physical location.

### 2. physical storage in /tmp/test-fns/{repo-dirname}/.temp/

**rationale**:
- `/tmp/` has no ancestors with `node_modules` or `package.json`
- `test-fns/` namespace avoids collision with other tools
- `{repo-dirname}/` isolates repos from each other
- `.temp/` matches the familiar gitroot convention

### 3. fail fast if /tmp/ absent

**rationale**: we explicitly target unix systems. if `/tmp/` is absent, the system is misconfigured. clear error is better than obscure failure.

### 4. symlink at gitroot for discoverability

**rationale**: users expect temp dirs at `@gitroot/.temp/genTempDir.symlink/`. the symlink preserves this mental model while physical files live in `/tmp/` for isolation.

---

## implementation order

1. `computeIsolatedTempBasePath` + unit tests
2. `genIsolatedTempInfra` + integration tests
3. eject `genEphemeralTempDir` from `genTempDir`
4. update `genTempDir` to use new infra
5. update `pruneStale` to use physical path
6. update prior integration tests
7. add acceptance tests for isolation
8. remove old `ensureTempDir` (no longer needed)
