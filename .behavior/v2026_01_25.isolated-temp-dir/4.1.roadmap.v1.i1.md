# roadmap: isolated temp dir

## overview

implement isolated temp directories per the blueprint at `3.3.blueprint.v1.i1.md`.

---

## phase 1: infra foundation

### 1.1 computeIsolatedTempBasePath

- [ ] create `src/infra/isomorph.fs/computeIsolatedTempBasePath.ts`
- [ ] create `src/infra/isomorph.fs/computeIsolatedTempBasePath.jest.test.ts`

**contract:**
```ts
computeIsolatedTempBasePath({ gitRoot: string }): string
// returns: /tmp/test-fns/{repo-dirname}/.temp
```

**verify:**
- [ ] unit tests pass
- [ ] path format matches `/tmp/test-fns/{repo-dirname}/.temp`

---

### 1.2 genIsolatedTempInfra

- [ ] create `src/infra/isomorph.fs/genIsolatedTempInfra.ts`
- [ ] create `src/infra/isomorph.fs/genIsolatedTempInfra.integration.jest.test.ts`

**contract:**
```ts
genIsolatedTempInfra({ gitRoot: string }): { pathPhysical: string; pathSymlink: string }
```

**behavior:**
1. validate `/tmp/` exists (throw if absent)
2. ensure `@gitroot/.temp/` dir exists
3. ensure `/tmp/test-fns/{repo-dirname}/.temp/` exists with readme + gitignore
4. ensure `@gitroot/.temp/genTempDir.symlink` is symlink to physical path

**verify:**
- [ ] integration tests pass
- [ ] `/tmp/` validation throws clear error when absent
- [ ] physical dir created at correct path
- [ ] symlink created at `@gitroot/.temp/genTempDir.symlink/`
- [ ] symlink target resolves to physical path
- [ ] readme.md present in physical dir
- [ ] .gitignore present in physical dir

**depends on:** 1.1

---

## phase 2: ephemeral dir extraction

### 2.1 genEphemeralTempDir

- [ ] create `src/domain.operations/genTempDir/genEphemeralTempDir.ts`
- [ ] create `src/domain.operations/genTempDir/genEphemeralTempDir.integration.jest.test.ts`

**contract:**
```ts
genEphemeralTempDir({
  slug: string;
  clone?: string;
  symlink?: Array<{ at: string; to: string }>;
  tempInfra: { pathPhysical: string };
  gitRoot: string;
}): string
// returns: tempDirName (e.g., 2026-01-25T12-34-56.789Z.my-test.a1b2c3d4)
```

**behavior:**
1. compute temp dir name from slug
2. create temp dir at pathPhysical
3. clone fixture if specified
4. create symlinks if specified (in physical temp dir, point to gitRoot)
5. return dirName

**verify:**
- [ ] integration tests pass
- [ ] temp dir created at `{pathPhysical}/{dirName}`
- [ ] dirName contains timestamp prefix
- [ ] dirName contains slug
- [ ] clone copies fixture contents
- [ ] symlinks created in physical temp dir
- [ ] symlinks resolve to gitRoot paths

**depends on:** 1.2

---

## phase 3: genTempDir integration

### 3.1 update genTempDir

- [ ] update `src/domain.operations/genTempDir/genTempDir.ts`
- [ ] update `src/domain.operations/genTempDir/genTempDir.integration.jest.test.ts`

**changes:**
- use `genIsolatedTempInfra` instead of `ensureTempDir`
- use `genEphemeralTempDir` for per-call creation
- return link path (`pathSymlink + dirName`)
- update `pruneStaleOnce` to use physical path

**verify:**
- [ ] integration tests pass
- [ ] returns path within `@gitroot/.temp/genTempDir.symlink/`
- [ ] physical files stored at `/tmp/test-fns/{repo-dirname}/.temp/`
- [ ] all prior behavior preserved (clone, symlink, prune)

**depends on:** 2.1

---

### 3.2 update pruneStale

- [ ] update `src/domain.operations/genTempDir/pruneStale.ts`

**changes:**
- prune from physical `/tmp/` location instead of gitroot

**verify:**
- [ ] integration tests pass
- [ ] stale dirs pruned from physical path
- [ ] fresh dirs preserved

**depends on:** 3.1

---

## phase 4: acceptance verification

### 4.1 acceptance tests

- [ ] update `src/domain.operations/genTempDir/genTempDir.acceptance.jest.test.ts`

**add tests for:**

```
usecase.2: isolation from gitroot module resolution
  given('[case5] a temp directory created by genTempDir')
    when('[t0] we check physical location')
      then('physical files are stored at /tmp/test-fns/{repo-dirname}/.temp/')
    when('[t1] we search upward for node_modules from within the temp dir')
      then('no node_modules is found in any ancestor directory')
    when('[t2] we search upward for package.json from within the temp dir')
      then('no package.json is found in any ancestor directory')

usecase.3: discoverability via symlink
  given('[case6] symlink at gitroot')
    when('[t0] we check @gitroot/.temp/genTempDir.symlink/')
      then('it is a symlink')
      then('symlink target is within /tmp/')
    when('[t1] we list contents via symlink')
      then('temp directories are visible')

boundary.1: /tmp/ validation
  given('[case7] /tmp/ does not exist')
    when('[t0] genTempDir is called')
      then('throws clear error about /tmp/ requirement')
```

**verify:**
- [ ] acceptance tests pass
- [ ] isolation from node_modules confirmed
- [ ] isolation from package.json confirmed
- [ ] symlink discoverability confirmed

**depends on:** 3.2

---

## phase 5: cleanup

### 5.1 remove ensureTempDir

- [ ] remove `src/infra/isomorph.fs/ensureTempDir.ts`
- [ ] remove any imports of `ensureTempDir`

**verify:**
- [ ] no references to `ensureTempDir` remain
- [ ] all tests pass
- [ ] build succeeds

**depends on:** 4.1

---

## final verification

- [ ] `npm run test:types` — type check pass
- [ ] `npm run test:lint` — lint pass
- [ ] `npm run test:unit` — unit tests pass
- [ ] `npm run test:integration` — integration tests pass
- [ ] `npm run test:acceptance` — acceptance tests pass
- [ ] manual verification: create temp dir, confirm physical location, confirm symlink works

---

## acceptance criteria summary

| criteria | verification |
|----------|--------------|
| physical files at `/tmp/test-fns/{repo}/.temp/` | acceptance test case5.t0 |
| no node_modules in ancestors | acceptance test case5.t1 |
| no package.json in ancestors | acceptance test case5.t2 |
| symlink at `@gitroot/.temp/genTempDir.symlink/` | acceptance test case6.t0 |
| symlink target within `/tmp/` | acceptance test case6.t0 |
| contents visible via symlink | acceptance test case6.t1 |
| clear error if `/tmp/` absent | acceptance test case7.t0 |
| api signature unchanged | integration tests |
| clone behavior preserved | integration tests |
| symlink-in-tempdir behavior preserved | integration tests |
| prune behavior preserved | integration tests |
