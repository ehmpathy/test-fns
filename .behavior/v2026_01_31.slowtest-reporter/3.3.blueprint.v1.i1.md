# blueprint: slowtest reporter

## summary

this blueprint describes the implementation plan for the slowtest reporter feature. the reporter provides hierarchical test time visibility for jest and vitest with terminal output and json export.

---

## filediff treestruct

```
src/
  contract/
    [~] index.ts                              # add slowtestReporter exports
    [+] slowtest.ts                           # secondary entrypoint for `test-fns/slowtest`
  domain.objects/
    [+] SlowtestReport.ts                     # report data structure
    [+] SlowtestConfig.ts                     # config options type
    [+] SlowtestBlock.ts                      # hierarchical block data
  domain.operations/
    slowtestReporter/
      [+] slowtestReporter.ts                           # factory (auto-detect runner)
      [+] slowtestReporter.jest.test.ts                 # factory unit tests (jest)
      [+] slowtestReporter.vitest.test.ts               # factory unit tests (vitest)
      [+] slowtestReporter.integration.jest.test.ts     # jest integration tests
      [+] slowtestReporter.integration.vitest.test.ts   # vitest integration tests
      reporter/
        [+] SlowtestReporterJest.ts                     # jest reporter class
        [+] SlowtestReporterVitest.ts                   # vitest reporter class
      hierarchy/
        [+] buildBlockHierarchy.ts                      # reconstruct given/when/then tree
        [+] buildBlockHierarchy.jest.test.ts            # hierarchy builder unit tests
        [+] computeHookDuration.ts                      # derive hook time from delta
        [+] computeHookDuration.jest.test.ts            # hook duration unit tests
      # duration format/parse via iso-time (external dependency)
      threshold/
        [+] evaluateThreshold.ts                        # slow classification
        [+] evaluateThreshold.jest.test.ts              # threshold unit tests
      output/
        [+] formatTerminalReport.ts                     # terminal output formatter
        [+] formatTerminalReport.jest.test.ts           # formatter unit tests
        [+] emitJsonReport.ts                          # json file writer
      .test/
        assets/
          [+] slow-suite/                               # fixture: tests with known durations
          [+] fast-suite/                               # fixture: all fast tests
          [+] hierarchy-suite/                          # fixture: nested given/when/then
          [+] plain-describe-suite/                     # fixture: plain describe blocks
[~] package.json                              # add exports for test-fns/slowtest
```

**legend:**
- `[+]` = create new file
- `[~]` = update prior file
- `[-]` = delete prior file (none in this blueprint)

---

## codepath treestruct

```
slowtestReporter (factory)
├── [←] detectTestRunner                      # reuse from infra/isomorph.test
├── [+] slowtestReporter.jest                 # create jest reporter class
│   ├── [+] onTestFileResult                  # collect per-file time
│   ├── [+] onRunComplete                     # emit terminal + json
│   └── [←] globals.afterAll                  # reuse for flush if needed
└── [+] slowtestReporter.vitest               # create vitest reporter class
    ├── [+] onTestCaseResult                  # collect per-test time
    ├── [+] onTestModuleEnd                   # collect per-file time
    └── [+] onFinished                        # emit terminal + json

buildBlockHierarchy
├── [←] given/when/then prefixes              # reuse name prefix detection
├── [+] parseBlockType                        # extract type from name
├── [+] reconstructTree                       # build nested structure
└── [+] computeBlockDurations                 # aggregate child durations

formatTerminalReport
├── [+] sortByDuration                        # slowest first
├── [←] iso-time.asHumanReadable              # ms to human string (reuse)
├── [+] renderTable                           # ascii table format
├── [+] renderHierarchy                       # indented block tree
└── [+] renderSummary                         # slow count, tips

emitJsonReport
├── [+] ensureOutputDir                       # mkdir -p
├── [+] formatFullReport                      # full nested structure
├── [+] formatShardReport                     # simplified shard format
└── [←] timestamp pattern                     # reuse iso timestamp

evaluateThreshold
├── [←] iso-time.asMilliseconds               # "3s" -> 3000 (reuse)
├── [+] getDefaultThreshold                   # scope-based defaults
└── [+] classifySlow                          # binary slow/not-slow

```

**legend:**
- `[+]` = create new codepath
- `[~]` = update prior codepath
- `[○]` = retain prior codepath unchanged
- `[-]` = delete prior codepath
- `[←]` = reuse prior codepath
- `[→]` = eject prior codepath (none)

---

## domain objects

### SlowtestConfig

```typescript
/**
 * .what = config for slowtest reporter
 * .why = allows users to customize slow threshold, output, and display
 */
interface SlowtestConfig {
  /** slow threshold in ms or human-readable string (e.g., "3s") */
  slow?: number | string;

  /** output json path (e.g., ".slowtest/report.json") */
  output?: string;

  /** output format: "full" for nested hierarchy, "shard" for simple map */
  format?: 'full' | 'shard';

  /** max files to show in terminal (default: all) */
  top?: number;

}
```

### SlowtestReport

```typescript
/**
 * .what = full slowtest report data
 * .why = captures all time data for terminal output and json export
 */
interface SlowtestReport {
  /** iso timestamp when report was generated */
  generated: string;

  /** summary statistics */
  summary: {
    /** total duration in ms */
    total: number;
    /** count of test files */
    files: number;
    /** count of files above slow threshold */
    slow: number;
  };

  /** per-file time data */
  files: SlowtestFileData[];
}
```

### SlowtestFileData

```typescript
/**
 * .what = time data for a single test file
 * .why = captures file-level and block-level time
 */
interface SlowtestFileData {
  /** relative path to test file */
  path: string;

  /** total file duration in ms */
  duration: number;

  /** whether file exceeds slow threshold */
  slow: boolean;


  /** nested block hierarchy (if bdd structure detected) */
  blocks?: SlowtestBlock[];
}
```

### SlowtestBlock

```typescript
/**
 * .what = time data for a describe/given/when block
 * .why = enables hierarchical drill-down into slow blocks
 */
interface SlowtestBlock {
  /** block type: "given", "when", "describe" */
  type: 'given' | 'when' | 'describe';

  /** block name (without prefix) */
  name: string;

  /** total block duration in ms */
  duration: number;

  /** derived hook duration: duration - sum(children) */
  hookDuration: number;

  /** child blocks */
  blocks?: SlowtestBlock[];

  /** leaf tests (then blocks) */
  tests?: SlowtestTest[];
}
```

### SlowtestTest

```typescript
/**
 * .what = time data for a single test (then block)
 * .why = leaf node in hierarchy
 */
interface SlowtestTest {
  /** test name (with "then: " prefix) */
  name: string;

  /** test duration in ms */
  duration: number;
}
```

---

## domain operations

### slowtestReporter (factory)

```typescript
/**
 * .what = factory function that returns runner-specific reporter
 * .why = provides unified api that auto-detects jest vs vitest
 */
export const slowtestReporter = (config?: SlowtestConfig) => {
  const runner = detectTestRunner();
  if (runner === 'jest') return new SlowtestReporterJest(config);
  if (runner === 'vitest') return new SlowtestReporterVitest(config);
  throw new UnexpectedCodePathError('unknown test runner', { runner });
};

// explicit runner methods for manual selection
slowtestReporter.jest = (config?: SlowtestConfig) => new SlowtestReporterJest(config);
slowtestReporter.vitest = (config?: SlowtestConfig) => new SlowtestReporterVitest(config);
```

### SlowtestReporterJest (class)

```typescript
/**
 * .what = jest reporter implementation
 * .why = collects time via jest reporter lifecycle hooks
 */
class SlowtestReporterJest implements Reporter {
  private config: SlowtestConfig;
  private files: SlowtestFileData[] = [];

  constructor(globalConfig: Config.GlobalConfig, options: SlowtestConfig) {
    this.config = options;
  }

  onTestFileResult(
    test: Test,
    testResult: TestResult,
    aggregatedResult: AggregatedResult,
  ): void {
    // collect file time from testResult.perfStats
    // collect test time from testResult.testResults
    // build hierarchy from ancestorTitles
  }

  onRunComplete(
    contexts: Set<Context>,
    results: AggregatedResult,
  ): Promise<void> {
    // format and emit terminal report
    // write json file if output configured
  }
}
```

### SlowtestReporterVitest (class)

```typescript
/**
 * .what = vitest reporter implementation
 * .why = collects time via vitest reporter interface
 */
class SlowtestReporterVitest implements Reporter {
  private config: SlowtestConfig;
  private files: Map<string, SlowtestFileData> = new Map();

  onTestCaseResult(testCase: TaskResultPack): void {
    // collect test time from testCase.diagnostic()
    // build hierarchy from fullName
  }

  onTestModuleEnd(module: TestModule): void {
    // finalize file time
  }

  onFinished(files: File[]): void {
    // format and emit terminal report
    // write json file if output configured
  }
}
```

### buildBlockHierarchy

```typescript
/**
 * .what = reconstruct nested given/when/then tree from flat test results
 * .why = jest and vitest provide flat results; we need hierarchy for report
 */
export const buildBlockHierarchy = (input: {
  tests: Array<{
    ancestorTitles: string[];  // jest: ["given: x", "when: y"]
    title: string;             // "then: z"
    duration: number;
  }>;
}): SlowtestBlock[] => {
  // parse block type from name prefix
  // build tree structure
  // compute hookDuration for each block
};
```

### computeHookDuration

```typescript
/**
 * .what = derive hook time from block duration minus child durations
 * .why = neither jest nor vitest expose individual hook durations
 */
export const computeHookDuration = (input: {
  blockDuration: number;
  childDurations: number[];
}): number => {
  const childSum = input.childDurations.reduce((a, b) => a + b, 0);
  return Math.max(0, input.blockDuration - childSum);
};
```

### formatTerminalReport

```typescript
/**
 * .what = format time data as terminal output
 * .why = provides human-readable slow test report
 */
export const formatTerminalReport = (input: {
  report: SlowtestReport;
  config: SlowtestConfig;
}): string => {
  // sort files by duration (slowest first)
  // apply top limit if configured
  // render table with hierarchy
  // render summary line
};
```

### duration format/parse (via iso-time)

```typescript
import { asMilliseconds, asHumanReadable } from 'iso-time';

// format: ms -> human-readable
asHumanReadable({ ms: 8710 }); // "8.71s"

// parse: human-readable -> ms
asMilliseconds({ duration: '3s' }); // 3000
```

### emitJsonReport

```typescript
/**
 * .what = write time data to json file
 * .why = enables tools, trends, and shard optimization
 */
export const emitJsonReport = async (input: {
  report: SlowtestReport;
  config: SlowtestConfig;
}): Promise<void> => {
  if (!input.config.output) return;

  // ensure output directory exists
  const dir = path.dirname(input.config.output);
  await fs.mkdir(dir, { recursive: true });

  // format based on config.format
  const content = input.config.format === 'shard'
    ? formatShardReport(input.report)
    : formatFullReport(input.report);

  await fs.writeFile(input.config.output, JSON.stringify(content, null, 2));
};
```

### evaluateThreshold

```typescript
/**
 * .what = classify file as slow or not slow
 * .why = binary classification for visibility
 */
export const evaluateThreshold = (input: {
  duration: number;
  threshold: number;
}): boolean => {
  return input.duration > input.threshold;
};
```


---

## test coverage plan

### unit tests

| file | tests | criteria covered |
|------|-------|------------------|
| `evaluateThreshold.jest.test.ts` | slow/not-slow classification | usecase.5 (threshold) |
| `buildBlockHierarchy.jest.test.ts` | tree reconstruction from flat results | usecase.2 (hierarchy) |
| `computeHookDuration.jest.test.ts` | hook time derivation | usecase.2 (hook time) |
| `formatTerminalReport.jest.test.ts` | terminal output format | usecase.1 (terminal) |

### integration tests

| file | tests | criteria covered |
|------|-------|------------------|
| `slowtestReporter.integration.jest.test.ts` | run jest fixture suite, verify output | usecase.1, usecase.2, usecase.3 |
| `slowtestReporter.integration.vitest.test.ts` | run vitest fixture suite, verify output | usecase.1, usecase.2, usecase.3 |

**integration test scenarios:**

```typescript
describe('slowtestReporter integration', () => {
  given('[case1] jest test suite with known durations', () => {
    when('[t0] reporter runs with default config', () => {
      then('terminal shows files sorted by duration');
      then('slowest file appears first');
      then('duration format is human-readable');
    });

    when('[t1] reporter runs with output configured', () => {
      then('json file is written');
      then('json includes generated timestamp');
      then('json includes summary');
      then('json includes files array');
    });

    when('[t2] reporter runs with format=shard', () => {
      then('json contains version and files map only');
    });
  });

  given('[case2] jest test suite with bdd hierarchy', () => {
    when('[t0] reporter runs', () => {
      then('terminal shows nested hierarchy');
      then('indentation reflects depth');
      then('hook time shows for blocks with setup');
    });
  });
});
```

---

## test fixtures

### slow-suite

```typescript
// .test/assets/slow-suite/slow.test.ts
import { given, when, then } from 'test-fns';

describe('slow suite', () => {
  given('[case1] slow setup', () => {
    beforeAll(async () => {
      await new Promise((r) => setTimeout(r, 500)); // 500ms setup
    });

    when('[t0] slow test', () => {
      then('takes time', async () => {
        await new Promise((r) => setTimeout(r, 200)); // 200ms test
        expect(true).toBe(true);
      });
    });
  });
});
```

### fast-suite

```typescript
// .test/assets/fast-suite/fast.test.ts
import { given, when, then } from 'test-fns';

describe('fast suite', () => {
  given('[case1] instant setup', () => {
    when('[t0] fast test', () => {
      then('instant', () => {
        expect(true).toBe(true);
      });
    });
  });
});
```

### hierarchy-suite

```typescript
// .test/assets/hierarchy-suite/nested.test.ts
import { given, when, then } from 'test-fns';

describe('hierarchy suite', () => {
  given('[case1] outer given', () => {
    given('[case1.1] nested given', () => {
      when('[t0] nested when', () => {
        then('leaf test', () => {
          expect(true).toBe(true);
        });
      });
    });

    when('[t0] outer when', () => {
      then('another leaf', () => {
        expect(true).toBe(true);
      });
    });
  });
});
```

### plain-describe-suite

```typescript
// .test/assets/plain-describe-suite/plain.test.ts
describe('plain suite', () => {
  describe('nested describe', () => {
    it('plain test', () => {
      expect(true).toBe(true);
    });
  });
});
```

---

## package.json updates

```json
{
  "exports": {
    ".": {
      "import": "./dist/esm/index.js",
      "require": "./dist/cjs/index.js",
      "types": "./dist/types/index.d.ts"
    },
    "./slowtest": {
      "import": "./dist/esm/contract/slowtest.js",
      "require": "./dist/cjs/contract/slowtest.js",
      "types": "./dist/types/contract/slowtest.d.ts"
    },
    "./vitest.setup": {
      "import": "./dist/esm/contract/vitest.setup.js",
      "require": "./dist/cjs/contract/vitest.setup.js",
      "types": "./dist/types/contract/vitest.setup.d.ts"
    }
  }
}
```

---

## implementation order

1. **domain objects** — define types for report, config, blocks
2. **pure operations** — evaluateThreshold (duration via iso-time)
3. **hierarchy builder** — buildBlockHierarchy, computeHookDuration
4. **formatters** — formatTerminalReport, emitJsonReport
5. **jest reporter** — SlowtestReporterJest class
6. **vitest reporter** — SlowtestReporterVitest class
7. **factory** — slowtestReporter with auto-detection
8. **contract exports** — update index.ts, create slowtest.ts
9. **package.json** — add exports field

each step includes related unit tests before implementation (tdd).

---

## risk mitigation

| risk | mitigation |
|------|------------|
| vitest reporter api differs from jest | research complete; use interface-based approach |
| thenable detection blocks exports | use namespace pattern (`slowtestReporter.vitest()`) |
| hook time derivation inaccurate | accept approximation; document limitation |
| parallel execution inflates times | use isolated test duration, not wall clock |
| large output floods terminal | implement top limit and pagination |

---

## success criteria

the implementation is complete when:

1. `slowtestReporter()` auto-detects runner and returns correct reporter
2. terminal output shows hierarchical time with human-readable durations
3. json export works in both full and shard formats
4. threshold classification works with ms and string formats
5. all blackbox criteria from `2.1.criteria.blackbox.md` are covered by tests
6. tests pass for both jest and vitest runners

---

## citations

- [1] jest reporter api: https://jestjs.io/docs/configuration#reporters-arraymodulename--modulename-options
- [2] vitest reporter api: https://vitest.dev/guide/reporters
- [3] jest testresult types: https://github.com/jestjs/jest/blob/main/packages/jest-types/src/TestResult.ts
- [4] vitest testcase types: https://vitest.dev/api/advanced/test-case
