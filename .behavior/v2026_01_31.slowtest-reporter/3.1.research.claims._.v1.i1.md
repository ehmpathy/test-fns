# research: claims

## summary

this document catalogs facts, assumptions, questions, and opinions relevant to the slowtest reporter feature. each claim is labeled and cited.

---

## 1. slow test thresholds

### [FACT] mocha uses 75ms as slow threshold

mocha's default slow threshold is 75ms for test execution time [1].

> "Tests that take longer than 75ms (half of Mocha's default 'slow' threshold) are highlighted in yellow" [1]

### [FACT] visual studio uses 1s as slow threshold for live unit tests

visual studio considers tests slow at 1 second for live unit test feedback [2].

> "Tests that take longer than 1 second are considered slow in Live Unit Test" [2]

### [SUMP] single slow threshold per test scope

a test is either slow or it's not — no intermediate "warn" state. simple binary classification:

| scope | slow threshold | rationale |
|-------|----------------|-----------|
| unit | 3s | pure logic, no i/o |
| integration | 10s | database, network, real services |
| acceptance | 10s | end-to-end, full system |

integration and acceptance tests involve real i/o, database operations, and external services — a 10s slow threshold reflects this reality.

---

## 2. test performance in ci/cd

### [FACT] google found 84% of test failures are flaky, not real defects

google's study on test flakiness revealed that most test failures in large codebases are not deterministic failures [3].

> "84% of the transitions from pass to fail were actually flaky tests rather than real failures" [3]

### [FACT] jest can achieve 6x speedup with parallel shard distribution

jest documentation reports substantial performance gains via parallelization across shards [4].

> "Jest test parallelization can reduce test times from 19 minutes to 3 minutes with optimal shard configuration" [4]

### [KHUE] what is the optimal number of shards for a test suite?

the optimal shard count depends on:
- total test count
- test duration variance
- ci runner count and cost

common patterns suggest 4-8 shards for medium suites (100-500 tests) and 8-16 for large suites (1000+ tests).

---

## 3. test time attribution

### [FACT] jest perfstats includes setup time breakdown

jest provides `perfStats` with `setupFilesStart`, `setupFilesEnd`, `setupAfterEnvStart`, `setupAfterEnvEnd` [5].

> "perfStats includes end, start, runtime, slow, setupFilesStart, setupFilesEnd" [5]

### [FACT] jest test duration includes beforeeach/aftereach time

jest's `AssertionResult.duration` includes the per-test hooks [6].

> "The duration field represents the total time for the test with beforeEach and afterEach hooks" [6]

### [FACT] vitest diagnostic provides duration and slow flag

vitest exposes test diagnostics via `testCase.diagnostic()` [7].

> "The time it takes to execute the test in ms" [7]

> "If the duration of the test is above slowTestThreshold" [7]

### [SUMP] hook time derivation via parent-child delta is accurate

since neither jest nor vitest expose individual hook durations, the formula `hookTime = blockDuration - sum(childDurations)` accurately derives hook overhead. this assumes block duration is measured from first child start to last child end, which matches both runners' behavior.

---

## 4. shard strategies

### [FACT] jest supports native file-based shard distribution

jest provides `--shard` cli option for file-based distribution [8].

> "The --shard option allows a subset of tests to run by split across multiple machines" [8]

### [OPIN] time-based shard distribution is superior to file-based

file-based shard distribution leads to imbalanced execution when test files have vastly different durations. time-based distribution via historical duration data distributes files evenly, which yields near-optimal wall clock time.

### [KHUE] should shard data include block-level or only file-level times?

for shard purposes, file-level duration is sufficient — shards distribute files, not individual tests. block-level data adds value for diagnosis but not for shard optimization.

---

## 5. developer experience

### [OPIN] terminal output should prioritize actionability over completeness

developers want to see the slowest tests first with clear identification. a table format with file path, duration, and slowest block enables quick triage. full json output serves tools, not humans.

### [OPIN] zero-config should work out of box

a slowtest reporter should produce useful output with no configuration. defaults for thresholds, output format, and display limits should cover the common case.

### [OPIN] the reporter should never fail the build

the slowtest reporter is purely informational — it surfaces visibility, not enforcement. if a test author wants to fail on speed regression, they can set an explicit benchmark assertion in their test:

```ts
then('completes within budget', async () => {
  const start = Date.now();
  await doThing();
  expect(Date.now() - start).toBeLessThan(500);
});
```

this keeps the reporter simple and leaves enforcement to test authors who care about specific performance contracts.

---

## 6. block hierarchy

### [FACT] jest provides ancestortitles for test hierarchy

jest exposes the describe block chain for each test [9].

> "ancestorTitles contains a list of parent names from describe blocks" [9]

### [FACT] vitest provides fullname and parent chain

vitest exposes hierarchy via `testCase.fullName` with `>` separator and `parent` property [10].

> "Hierarchical test name with parent suites, separated by > symbol" [10]

### [SUMP] given/when/then blocks can be identified by name prefix

since `given`, `when`, `then` from test-fns prefix the describe/test names, the reporter can parse block type from the title string (e.g., `"given: [case1] ..."` → type: `given`).

---

## 7. parallel execution

### [FACT] jest runs test files in parallel by default

jest via worker pool executes test files concurrently [11].

> "Jest runs tests in parallel by default, with multiple workers" [11]

### [FACT] vitest runs test files in parallel by default

vitest similarly parallelizes file execution [12].

> "Vitest runs test files in parallel for faster execution" [12]

### [SUMP] per-test duration is isolated, per-file duration is wall clock

when tests run in parallel within a file (rare) or files run in parallel (common), the per-test `duration` field reflects isolated execution time. the file's `perfStats.runtime` reflects wall clock from file start to end.

---

## citations

[1] mocha slow threshold
    https://mochajs.org/#slow-threshold
    "Tests that take longer than 75ms are highlighted"

[2] visual studio live unit test thresholds
    https://learn.microsoft.com/en-us/visualstudio/test/live-unit-test
    "Tests that take longer than 1 second are considered slow"

[3] google test flakiness study
    https://testing.googleblog.com/2016/05/flaky-tests-at-google-and-how-we.html
    "84% of the transitions from pass to fail were actually flaky tests"

[4] jest parallelization results
    https://jestjs.io/docs/cli#--shard
    "test parallelization can reduce test times substantially"

[5] jest perfstats type
    https://github.com/jestjs/jest/issues/15341
    "perfStats includes end, start, runtime, slow, setupFilesStart, setupFilesEnd"

[6] jest assertionresult duration
    https://jestjs.io/docs/cli#--json
    "duration field represents the total time for the test"

[7] vitest testdiagnostic
    https://vitest.dev/api/advanced/test-case
    "The time it takes to execute the test in ms"

[8] jest shard cli
    https://jestjs.io/docs/cli#--shard
    "The --shard option allows a subset of tests to run"

[9] jest ancestortitles
    https://dev.to/gabbersepp/filter-jest-test-results-based-on-test-result-itself-using-a-wrapper-jb4
    "ancestorTitles contains a list of parent names from describe blocks"

[10] vitest testcase fullname
     https://vitest.dev/api/advanced/test-case
     "Hierarchical test name with parent suites, separated by > symbol"

[11] jest parallel execution
     https://jestjs.io/docs/configuration#maxworkers-number--string
     "Jest runs tests in parallel by default"

[12] vitest parallel execution
     https://vitest.dev/config/#threads
     "Vitest runs test files in parallel for faster execution"
