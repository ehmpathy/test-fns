# roadmap: slowtest reporter

## overview

this roadmap provides an ordered checklist for execution of the slowtest reporter blueprint. each phase has dependencies, acceptance criteria, and verification steps.

---

## phase 0: preparation

### 0.1 add iso-time dependency

- [ ] **task**: add `iso-time` to dependencies
- **depends on**: none
- **files**: `package.json`
- **acceptance criteria**:
  - `iso-time` listed in dependencies
  - `npm install` succeeds
- **verify**:
  ```sh
  npm install iso-time
  npm run build:compile
  ```

---

## phase 1: domain objects

### 1.1 create SlowtestConfig type

- [ ] **task**: define config options interface
- **depends on**: 0.1
- **files**: `src/domain.objects/SlowtestConfig.ts`
- **acceptance criteria**:
  - interface has `slow`, `output`, `format`, `top` properties
  - all properties are optional
  - `slow` accepts `number | string`
  - `format` is `'full' | 'shard'`
- **verify**:
  ```sh
  npm run test:types
  ```

### 1.2 create SlowtestBlock type

- [ ] **task**: define hierarchical block data structure
- **depends on**: none
- **files**: `src/domain.objects/SlowtestBlock.ts`
- **acceptance criteria**:
  - interface has `type`, `name`, `duration`, `hookDuration`
  - `type` is `'given' | 'when' | 'describe'`
  - optional `blocks` and `tests` arrays for nested structure
- **verify**:
  ```sh
  npm run test:types
  ```

### 1.3 create SlowtestReport type

- [ ] **task**: define report data structure
- **depends on**: 1.2
- **files**: `src/domain.objects/SlowtestReport.ts`
- **acceptance criteria**:
  - includes `generated` timestamp string
  - includes `summary` with `total`, `files`, `slow` counts
  - includes `files` array with `SlowtestFileData`
  - `SlowtestFileData` has `path`, `duration`, `slow`, optional `blocks`
- **verify**:
  ```sh
  npm run test:types
  ```

---

## phase 2: pure operations

### 2.1 create evaluateThreshold

- [ ] **task**: implement slow classification function
- **depends on**: 0.1, 1.1
- **files**:
  - `src/domain.operations/slowtestReporter/threshold/evaluateThreshold.ts`
  - `src/domain.operations/slowtestReporter/threshold/evaluateThreshold.jest.test.ts`
- **acceptance criteria**:
  - returns `true` when duration > threshold
  - returns `false` when duration <= threshold
  - uses `iso-time` to parse string thresholds (e.g., "3s" -> 3000)
- **verify**:
  ```sh
  npm run test:unit -- evaluateThreshold
  ```
- **blackbox criteria covered**:
  - usecase.5: threshold classification

### 2.2 create computeHookDuration

- [ ] **task**: implement hook time derivation
- **depends on**: none
- **files**:
  - `src/domain.operations/slowtestReporter/hierarchy/computeHookDuration.ts`
  - `src/domain.operations/slowtestReporter/hierarchy/computeHookDuration.jest.test.ts`
- **acceptance criteria**:
  - returns `blockDuration - sum(childDurations)`
  - returns `0` when result would be negative
- **verify**:
  ```sh
  npm run test:unit -- computeHookDuration
  ```
- **blackbox criteria covered**:
  - usecase.2: hook time derived from delta

---

## phase 3: hierarchy builder

### 3.1 create buildBlockHierarchy

- [ ] **task**: implement tree reconstruction from flat test results
- **depends on**: 1.2, 2.2
- **files**:
  - `src/domain.operations/slowtestReporter/hierarchy/buildBlockHierarchy.ts`
  - `src/domain.operations/slowtestReporter/hierarchy/buildBlockHierarchy.jest.test.ts`
- **acceptance criteria**:
  - accepts flat array with `ancestorTitles`, `title`, `duration`
  - parses block type from name prefix (`given:`, `when:`, `then:`)
  - builds nested tree structure
  - computes `hookDuration` for each block via `computeHookDuration`
  - handles plain `describe` blocks (no prefix)
- **verify**:
  ```sh
  npm run test:unit -- buildBlockHierarchy
  ```
- **blackbox criteria covered**:
  - usecase.2: nested hierarchy reconstruction
  - usecase.2: full hierarchy for nested given inside given

---

## phase 4: output formatters

### 4.1 create formatTerminalReport

- [ ] **task**: implement terminal output formatter
- **depends on**: 0.1, 1.3, 2.1
- **files**:
  - `src/domain.operations/slowtestReporter/output/formatTerminalReport.ts`
  - `src/domain.operations/slowtestReporter/output/formatTerminalReport.jest.test.ts`
- **acceptance criteria**:
  - sorts files by duration (slowest first)
  - applies `top` limit when configured
  - renders ascii table with file paths and durations
  - renders indented hierarchy for blocks
  - uses `iso-time` for human-readable durations (e.g., "8.71s")
  - renders summary line with slow count
  - marks slow files visually
- **verify**:
  ```sh
  npm run test:unit -- formatTerminalReport
  ```
- **blackbox criteria covered**:
  - usecase.1: files sorted by duration
  - usecase.1: human-readable duration format
  - usecase.1: top limit respected
  - usecase.2: indentation reflects nest depth

### 4.2 create emitJsonReport

- [ ] **task**: implement json file writer
- **depends on**: 1.1, 1.3
- **files**:
  - `src/domain.operations/slowtestReporter/output/emitJsonReport.ts`
- **acceptance criteria**:
  - creates output directory if absent
  - writes full report when `format: 'full'` or unset
  - writes shard report when `format: 'shard'`
  - shard format: `{ version: 1, files: { path: duration } }`
  - full format: includes nested `blocks` array
- **verify**:
  ```sh
  npm run test:types
  ```
- **blackbox criteria covered**:
  - usecase.3: json written to configured path
  - usecase.3: full format with nested blocks
  - usecase.3: shard format with simple map
  - usecase.3: directory created if absent

---

## phase 5: test fixtures

### 5.1 create test fixture suites

- [ ] **task**: create fixture test suites for integration tests
- **depends on**: none (can be done in parallel with phases 1-4)
- **files**:
  - `src/domain.operations/slowtestReporter/.test/assets/slow-suite/slow.test.ts`
  - `src/domain.operations/slowtestReporter/.test/assets/fast-suite/fast.test.ts`
  - `src/domain.operations/slowtestReporter/.test/assets/hierarchy-suite/nested.test.ts`
  - `src/domain.operations/slowtestReporter/.test/assets/plain-describe-suite/plain.test.ts`
- **acceptance criteria**:
  - `slow-suite`: has 500ms beforeAll + 200ms test
  - `fast-suite`: instant tests only
  - `hierarchy-suite`: nested given/when/then blocks
  - `plain-describe-suite`: standard describe/it blocks (no bdd)
- **verify**:
  ```sh
  npm run test:unit -- slow-suite
  npm run test:unit -- fast-suite
  npm run test:unit -- hierarchy-suite
  npm run test:unit -- plain-describe-suite
  ```

---

## phase 6: jest reporter

### 6.1 create SlowtestReporterJest class

- [ ] **task**: implement jest reporter
- **depends on**: 1.1, 1.3, 2.1, 3.1, 4.1, 4.2
- **files**:
  - `src/domain.operations/slowtestReporter/reporter/SlowtestReporterJest.ts`
- **acceptance criteria**:
  - implements jest `Reporter` interface
  - `onTestFileResult`: collects file and test durations
  - `onTestFileResult`: builds hierarchy from `ancestorTitles`
  - `onRunComplete`: formats and prints terminal report
  - `onRunComplete`: writes json file if `output` configured
- **verify**:
  ```sh
  npm run test:types
  ```
- **blackbox criteria covered**:
  - usecase.1: terminal report after test completion
  - usecase.2: hierarchy from ancestorTitles
  - usecase.3: json export

### 6.2 create jest integration tests

- [ ] **task**: implement integration tests for jest reporter
- **depends on**: 5.1, 6.1
- **files**:
  - `src/domain.operations/slowtestReporter/slowtestReporter.integration.jest.test.ts`
- **acceptance criteria**:
  - runs fixture suites with reporter
  - verifies terminal output format
  - verifies json output structure
  - verifies hierarchy in output
- **verify**:
  ```sh
  npm run test:integration -- slowtestReporter.integration.jest
  ```
- **blackbox criteria covered**:
  - usecase.1: terminal output verification
  - usecase.2: hierarchy verification
  - usecase.3: json output verification

---

## phase 7: vitest reporter

### 7.1 create SlowtestReporterVitest class

- [ ] **task**: implement vitest reporter
- **depends on**: 1.1, 1.3, 2.1, 3.1, 4.1, 4.2
- **files**:
  - `src/domain.operations/slowtestReporter/reporter/SlowtestReporterVitest.ts`
- **acceptance criteria**:
  - implements vitest `Reporter` interface
  - `onTestCaseResult`: collects test duration
  - `onTestModuleEnd`: finalizes file duration
  - `onFinished`: formats and prints terminal report
  - `onFinished`: writes json file if `output` configured
- **verify**:
  ```sh
  npm run test:types
  ```
- **blackbox criteria covered**:
  - usecase.1: terminal report for vitest
  - usecase.2: hierarchy from fullName
  - usecase.3: json export for vitest

### 7.2 create vitest integration tests

- [ ] **task**: implement integration tests for vitest reporter
- **depends on**: 5.1, 7.1
- **files**:
  - `src/domain.operations/slowtestReporter/slowtestReporter.integration.vitest.test.ts`
- **acceptance criteria**:
  - runs fixture suites with vitest + reporter
  - verifies terminal output format matches jest
  - verifies json output structure matches jest
- **verify**:
  ```sh
  npm run test:integration -- slowtestReporter.integration.vitest
  ```
- **blackbox criteria covered**:
  - usecase.1: identical report format as jest

---

## phase 8: factory and exports

### 8.1 create slowtestReporter factory

- [ ] **task**: implement factory with auto-detection
- **depends on**: 6.1, 7.1
- **files**:
  - `src/domain.operations/slowtestReporter/slowtestReporter.ts`
  - `src/domain.operations/slowtestReporter/slowtestReporter.jest.test.ts`
  - `src/domain.operations/slowtestReporter/slowtestReporter.vitest.test.ts`
- **acceptance criteria**:
  - `slowtestReporter()` auto-detects runner via `detectTestRunner`
  - `slowtestReporter.jest()` returns jest reporter
  - `slowtestReporter.vitest()` returns vitest reporter
  - throws `UnexpectedCodePathError` for unknown runner
- **verify**:
  ```sh
  npm run test:unit -- slowtestReporter.jest.test
  npm run test:unit -- slowtestReporter.vitest.test
  ```

### 8.2 create contract exports

- [ ] **task**: export slowtestReporter from contract layer
- **depends on**: 8.1
- **files**:
  - `src/contract/slowtest.ts` (new)
  - `src/contract/index.ts` (update)
- **acceptance criteria**:
  - `slowtest.ts` exports `slowtestReporter`
  - `index.ts` re-exports from `slowtest.ts`
  - no top-level `then` export (thenable hazard)
- **verify**:
  ```sh
  npm run test:types
  npm run build:compile
  ```

### 8.3 update package.json exports

- [ ] **task**: add exports field for `test-fns/slowtest`
- **depends on**: 8.2
- **files**:
  - `package.json`
- **acceptance criteria**:
  - `"./slowtest"` export points to `dist/*/contract/slowtest.js`
  - import works: `import { slowtestReporter } from 'test-fns/slowtest'`
- **verify**:
  ```sh
  npm run build
  node -e "require('./dist/cjs/contract/slowtest.js')"
  ```

---

## phase 9: final verification

### 9.1 run all tests

- [ ] **task**: verify all tests pass
- **depends on**: all prior phases
- **verify**:
  ```sh
  npm run test:types
  npm run test:unit
  npm run test:integration
  ```

### 9.2 verify blackbox criteria coverage

- [ ] **task**: review all criteria from `2.1.criteria.blackbox.md`
- **depends on**: 9.1
- **acceptance criteria checklist**:

  **usecase.1 - diagnose slow tests via terminal**:
  - [ ] terminal displays report after standard output
  - [ ] files sorted by duration, slowest first
  - [ ] duration in human-readable format
  - [ ] respects `top` limit
  - [ ] vitest format identical to jest
  - [ ] slow files visually marked

  **usecase.2 - block-level hierarchy**:
  - [ ] nested hierarchy: file > given > when > then
  - [ ] each level shows duration
  - [ ] indentation reflects depth
  - [ ] nested given inside given preserved
  - [ ] hook time derived and labeled
  - [ ] plain describe gracefully handled

  **usecase.3 - json export**:
  - [ ] json written to configured path
  - [ ] includes timestamp
  - [ ] includes summary
  - [ ] full format has nested blocks
  - [ ] shard format has version + files map
  - [ ] output directory created if absent

  **usecase.5 - thresholds**:
  - [ ] ms threshold works
  - [ ] string threshold parsed ("3s")
  - [ ] default threshold applied when unset

  **usecase.6 - edge cases**:
  - [ ] empty test file reports 0ms
  - [ ] 1000+ files: terminal paginated, json complete
  - [ ] parallel tests: isolated durations
  - [ ] identical names distinguished by path

---

## dependency graph

```
phase 0 (prep)
    │
    ▼
phase 1 (types) ─────────────────────────────┐
    │                                         │
    ▼                                         │
phase 2 (pure ops) ──────────────────────┐   │
    │                                     │   │
    ▼                                     │   │
phase 3 (hierarchy)                       │   │
    │                                     │   │
    ├───────────────────────────────────► │   │
    │                                     ▼   ▼
    │                              phase 4 (formatters)
    │                                     │
    │                                     │
phase 5 (fixtures) ◄──────────────────────┤
    │                                     │
    ▼                                     ▼
phase 6 (jest reporter) ◄─────────────────┤
    │                                     │
    ▼                                     │
phase 7 (vitest reporter) ◄───────────────┘
    │
    ▼
phase 8 (factory + exports)
    │
    ▼
phase 9 (verification)
```

---

## brief references

before each phase, review relevant briefs:

| phase | briefs to review |
|-------|------------------|
| 1 | `ref.package.domain-objects.[ref].md` |
| 2-4 | `rule.require.input-context-pattern`, `rule.require.single-responsibility` |
| 5-7 | `ref.package.test-fns.[ref].md`, `howto.write-bdd.[lesson].md` |
| 8 | `limitation.esm-thenable-then-export.md` |

---

## citations

- blueprint: `.behavior/v2026_01_31.slowtest-reporter/3.3.blueprint.v1.i1.md`
- blackbox criteria: `.behavior/v2026_01_31.slowtest-reporter/2.1.criteria.blackbox.md`
- vision: `.behavior/v2026_01_31.slowtest-reporter/1.vision.md`
