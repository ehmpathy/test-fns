# research: remote access

## summary

the slowtest reporter requires integration with two test runner reporter apis:
1. **jest reporter api** — class-based interface with lifecycle hooks
2. **vitest reporter api** — interface-based with lifecycle methods

additionally, filesystem access is required for json output.

---

## 1. jest reporter api

### 1.1 interface

jest reporters are classes that implement lifecycle hook methods [1].

```typescript
export interface Reporter {
  readonly onRunStart?: (results: AggregatedResult, options: ReporterOnStartOptions) => Promise<void> | void;
  readonly onTestStart?: (test: Test) => Promise<void> | void;
  readonly onTestFileStart?: (test: Test) => Promise<void> | void;
  readonly onTestCaseStart?: (test: Test, testCaseStartInfo: Circus.TestCaseStartInfo) => Promise<void> | void;
  readonly onTestCaseResult?: (test: Test, testCaseResult: TestCaseResult) => Promise<void> | void;
  readonly onTestResult?: (test: Test, testResult: TestResult, aggregatedResult: AggregatedResult) => Promise<void> | void;
  readonly onTestFileResult?: (test: Test, testResult: TestResult, aggregatedResult: AggregatedResult) => Promise<void> | void;
  readonly onRunComplete?: (testContexts: Set<TestContext>, results: AggregatedResult) => Promise<void> | void;
  readonly getLastError?: () => Error | void;
}
```

> "Custom reporter modules must define a class that takes a GlobalConfig and reporter options as constructor arguments" [1]

### 1.2 time data

jest provides time data at multiple levels [2][3]:

**per-file (TestResult.perfStats)**:
```typescript
perfStats: {
  end: Milliseconds,
  start: Milliseconds,
  runtime: number,
  slow: boolean,
  // setup time breakdown
  setupFilesStart: Milliseconds,
  setupFilesEnd: Milliseconds,
  setupAfterEnvStart: Milliseconds,
  setupAfterEnvEnd: Milliseconds,
}
```

**per-test (AssertionResult)**:
```typescript
{
  duration: number | null,
  startAt: Milliseconds | null,
  ancestorTitles: string[], // describe block hierarchy
  title: string,            // test name
  status: 'passed' | 'failed' | 'queued',
}
```

> "The time in ms when the test started" [2]

### 1.3 block hierarchy

jest provides `ancestorTitles` array for each test result [4]:

> "ancestorTitles contains a list of parent names from describe blocks" [4]

this allows reconstruction of given/when/then hierarchy from flat test results.

### 1.4 configuration

```typescript
// jest.config.ts
const config = {
  reporters: [
    'default',
    ['<rootDir>/custom-reporter.js', { option: 'value' }],
  ],
};
```

> "If custom reporters are specified, the default Jest reporters will be overridden. To keep default reporters, default can be passed as a module name" [1]

---

## 2. vitest reporter api

### 2.1 interface

vitest reporters implement the `Reporter` interface [5]:

```typescript
import type { Reporter } from 'vitest/node'

export default class CustomReporter implements Reporter {
  onInit(vitest: Vitest) {}
  onTestRunStart(specifications: TestSpecification[]) {}
  onTestModuleQueued(testModule: TestModule) {}
  onTestModuleCollected(testModule: TestModule) {}
  onTestModuleStart(testModule: TestModule) {}
  onTestModuleEnd(testModule: TestModule) {}
  onTestSuiteReady(testSuite: TestSuite) {}
  onTestSuiteResult(testSuite: TestSuite) {}
  onTestCaseReady(testCase: TestCase) {}
  onTestCaseResult(testCase: TestCase) {}
  onTestRunEnd(testModules: TestModule[], unhandledErrors: unknown[], reason: TestRunEndReason) {}
}
```

> "Vitest has its own test run lifecycle, which is represented by reporter's methods" [5]

### 2.2 time data

vitest provides time data via the `diagnostic()` method on TestCase [6]:

```typescript
interface TestDiagnostic {
  readonly slow: boolean        // if duration > slowTestThreshold
  readonly duration: number     // execution time in ms
  readonly startTime: number    // epoch when test started
  readonly heap: number | undefined
  readonly retryCount: number
  readonly repeatCount: number
  readonly flaky: boolean
}
```

> "The time it takes to execute the test in ms" [6]

> "If the duration of the test is above slowTestThreshold" [6]

### 2.3 block hierarchy

vitest provides hierarchy via `TestCase` and `TestSuite` objects [7]:

```typescript
testCase.name       // "it should return true"
testCase.fullName   // "describe > nested describe > it should return true"
testCase.parent     // TestSuite or TestModule
testSuite.children  // TestCollection of nested suites/tests
```

> "Hierarchical test name with parent suites, separated by > symbol" [7]

**limitation**: TestSuite does not expose direct duration [8]:

> "The documentation does not expose duration methods directly. Suite time data would need to be derived from child test results" [8]

### 2.4 configuration

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import CustomReporter from './custom-reporter.js'

export default defineConfig({
  test: {
    reporters: [new CustomReporter()],
  },
})
```

> "Configure custom reporters in vitest.config.ts" [5]

---

## 3. filesystem access

### 3.1 contract

json output requires:
- write file to configured path
- create parent directory if absent
- atomic write (avoid partial files on crash)

### 3.2 best practice (within repo)

this repo uses node:fs/promises for async filesystem operations:

```typescript
import * as fs from 'node:fs/promises';
import * as path from 'node:path';

// create directory
await fs.mkdir(path.dirname(outputPath), { recursive: true });

// write file
await fs.writeFile(outputPath, JSON.stringify(data, null, 2));
```

---

## 4. key constraints

| constraint | jest | vitest |
|------------|------|--------|
| per-test duration | `TestResult.duration` | `testCase.diagnostic().duration` |
| block hierarchy | `ancestorTitles[]` | `testCase.fullName` / `parent` chain |
| per-suite duration | not direct; sum children | not direct; sum children |
| per-file duration | `perfStats.runtime` | sum of test durations |
| slow threshold | manual comparison | `diagnostic().slow` (built-in) |

---

## 5. hook time derivation

### 5.1 problem

neither jest nor vitest expose individual hook durations directly:

| hook | jest | vitest |
|------|------|--------|
| beforeAll | not exposed; in file setup time | `onHookStart`/`onHookEnd` events exist but no duration in context |
| afterAll | not exposed | `onHookStart`/`onHookEnd` events exist but no duration in context |
| beforeEach | included in test `duration` | `onHookStart`/`onHookEnd` events exist but no duration in context |
| afterEach | included in test `duration` | `onHookStart`/`onHookEnd` events exist but no duration in context |

vitest's `ReportedHookContext` type [9]:
```typescript
export type ReportedHookContext = {
  readonly name: 'beforeAll' | 'afterAll'
  readonly entity: TestSuite | TestModule
} | {
  readonly name: 'beforeEach' | 'afterEach'
  readonly entity: TestCase
}
```

note: no `duration` field — only `name` and `entity`.

### 5.2 solution: derive from parent-child delta

hook time can be derived via subtraction:

```
hookTime = blockDuration - sum(childDurations)
```

**example**:
```
given: [case1] overdue invoice        7.23s  (total)
  ├─ hooks (beforeAll + afterAll)     5.50s  ← derived: 7.23 - 1.73
  └─ when: [t0] nurture triggered     1.73s  (child sum)
```

**rationale**:
- semantically accurate: the block duration _includes_ its hooks
- no manual time capture needed: works for both jest and vitest
- actionable: users see hook time and know to optimize `useBeforeAll`

### 5.3 attribution rules

| block type | duration includes | hook time = |
|------------|-------------------|-------------|
| file | all tests + all hooks | file - sum(top-level blocks) |
| given | beforeAll + children + afterAll | given - sum(when blocks) |
| when | beforeEach (per test) + children + afterEach (per test) | when - sum(then blocks) |
| then | beforeEach + test body + afterEach | then - test body (if separable) |

**note**: for `then` blocks, beforeEach/afterEach are per-test. in jest, test `duration` already includes these hooks. in vitest, can derive via `onHookStart`/`onHookEnd` if needed, but parent-child delta is simpler.

---

## citations

[1] jest configuration - reporters
    https://jestjs.io/docs/configuration
    "Custom reporter modules must define a class that takes a GlobalConfig and reporter options as constructor arguments"

[2] jest types - TestResult perfStats
    https://github.com/jestjs/jest/issues/15341
    "perfStats includes end, start, runtime, slow, setupFilesStart, setupFilesEnd"

[3] jest formatTestResults
    https://github.com/jestjs/jest/blob/main/packages/jest-test-result/src/formatTestResults.ts
    "derives endTime from testResult.perfStats.end and startTime from testResult.perfStats.start"

[4] jest ancestorTitles
    https://dev.to/gabbersepp/filter-jest-test-results-based-on-test-result-itself-using-a-wrapper-jb4
    "ancestorTitles contains a list of parent names from describe blocks"

[5] vitest extend reporters
    https://vitest.dev/advanced/reporters
    "Vitest has its own test run lifecycle, which is represented by reporter's methods"

[6] vitest TestDiagnostic
    https://vitest.dev/api/advanced/test-case
    "The time it takes to execute the test in ms"

[7] vitest TestCase fullName
    https://vitest.dev/api/advanced/test-case
    "Hierarchical test name with parent suites, separated by > symbol"

[8] vitest TestSuite limitations
    https://vitest.dev/api/advanced/test-suite
    "The documentation does not expose duration methods directly"

[9] vitest ReportedHookContext type
    https://github.com/vitest-dev/vitest/blob/main/packages/vitest/src/node/reporters/reported-tasks.ts
    "readonly name: 'beforeAll' | 'afterAll' ... readonly entity: TestSuite | TestModule"
