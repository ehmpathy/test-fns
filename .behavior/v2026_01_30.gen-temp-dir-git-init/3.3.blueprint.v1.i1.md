# blueprint: genTempDir git initialization

## overview

add git repo initialization support to `genTempDir` via a new `git` option that:
1. runs `git init` in the temp directory
2. configures repo-local user identity (ci-safe)
3. creates an initial 'began' commit (optional)
4. creates a 'fixture' commit after clone/symlinks (optional)

---

## filediffs treestruct

```
src/
├── domain.operations/genTempDir/
│   ├── [~] genTempDir.ts                          # add git option to contract
│   ├── [~] genEphemeralTempDir.ts                 # orchestrate git init flow
│   └── [~] genTempDir.acceptance.jest.test.ts     # add git acceptance tests
│
├── infra/isomorph.fs/
│   ├── [+] initGitRepo.ts                         # git init + config
│   ├── [+] initGitRepo.integration.jest.test.ts   # integration tests
│   ├── [+] commitGitChanges.ts                    # git add + commit
│   └── [+] commitGitChanges.integration.jest.test.ts
│
├── contract/
│   └── [○] index.ts                               # retain (auto-exports)
│
└── [~] readme.md                                  # document git option

.behavior/
└── v2026_01_30.gen-temp-dir-git-init/
    └── [+] 3.3.blueprint.v1.i1.md                 # this file
```

---

## codepaths treestruct

```
genTempDir(input)
├── [○] getGitRoot()
├── [○] genIsolatedTempInfra({ gitRoot })
├── [○] pruneStaleOnce({ tmpDir })
├── [~] genEphemeralTempDir({ ..., git })
│   ├── [○] computeTempDirName({ slug })
│   ├── [○] fs.mkdirSync(tempDir)
│   │
│   ├── [+] if (git) initGitRepo({ tempDir })              # NEW
│   │   ├── [+] execSync('git init')
│   │   ├── [+] execSync('git config user.name')
│   │   └── [+] execSync('git config user.email')
│   │
│   ├── [+] if (git.commits.init) commitGitChanges(...)    # NEW: 'began'
│   │   ├── [+] execSync('git add .')
│   │   └── [+] execSync('git commit --allow-empty')
│   │
│   ├── [○] if (clone) cloneFixture({ from, to })
│   ├── [○] if (symlink) createSymlinks({ ... })
│   │
│   ├── [+] if (git.commits.fixture && hasContent)         # NEW: 'fixture'
│   │   └── [←] commitGitChanges({ tempDir, message: 'fixture' })
│   │
│   └── [○] return dirName
│
└── [○] return path.join(tempInfra.pathSymlink, dirName)
```

---

## contracts

### input contract change

```ts
// before
export const genTempDir = (input: {
  slug: string;
  clone?: string;
  symlink?: Array<{ at: string; to: string }>;
}): string

// after
export const genTempDir = (input: {
  slug: string;
  clone?: string;
  symlink?: Array<{ at: string; to: string }>;
  git?: boolean | {
    commits?: {
      init?: boolean;    // default: true
      fixture?: boolean; // default: true
    };
  };
}): string
```

### initGitRepo contract

```ts
/**
 * .what = initializes a git repository with repo-local user config
 * .why = enables ci-safe git repos without global git config dependency
 */
export const initGitRepo = (input: {
  tempDir: string;
  user?: {
    name?: string;  // default: 'test-fns'
    email?: string; // default: 'test-fns@test.local'
  };
}): void
```

### commitGitChanges contract

```ts
/**
 * .what = stages all changes and commits with the given message
 * .why = encapsulates git add + commit for reuse
 */
export const commitGitChanges = (input: {
  tempDir: string;
  message: string;
  allowEmpty?: boolean; // default: false
}): void
```

---

## execution timeline

```
1. genTempDir({ slug, clone, symlink, git: true })
2.   ├─ getGitRoot()
3.   ├─ genIsolatedTempInfra()
4.   ├─ pruneStaleOnce()
5.   └─ genEphemeralTempDir()
6.        ├─ computeTempDirName()
7.        ├─ fs.mkdirSync()
8.        ├─ initGitRepo()                    # git init + config
9.        ├─ commitGitChanges('began')        # if commits.init
10.       ├─ cloneFixture()                   # if clone
11.       ├─ createSymlinks()                 # if symlink
12.       ├─ commitGitChanges('fixture')      # if commits.fixture && hasContent
13.       └─ return dirName
14.  └─ return symlinkPath
```

---

## test coverage plan

### unit tests

| file | coverage |
|------|----------|
| `initGitRepo.ts` | n/a — uses execSync, covered by integration |
| `commitGitChanges.ts` | n/a — uses execSync, covered by integration |

### integration tests

| file | cases |
|------|-------|
| `initGitRepo.integration.jest.test.ts` | repo created, user config set, ci-safe (no global config) |
| `commitGitChanges.integration.jest.test.ts` | commits staged files, allow-empty works, message correct |

### acceptance tests (blackbox via contract)

| case | description |
|------|-------------|
| `[case8] git: true` | returns dir that is a valid git repo |
| `[case8] git: true` | git log shows 'began' commit |
| `[case8] git: true + clone` | git log shows 'began' then 'fixture' |
| `[case8] git: true + clone` | work tree is clean after return |
| `[case9] git: { commits: { init: false } }` | git repo exists but no commits |
| `[case9] git: { commits: { init: false } }` | work tree shows untracked files |
| `[case10] git: { commits: { fixture: false } }` | 'began' commit exists |
| `[case10] git: { commits: { fixture: false } }` | cloned files are uncommitted |
| `[case11] git: true, no clone/symlink` | only 'began' commit (no 'fixture') |

---

## implementation details

### git defaults

```ts
const GIT_DEFAULTS = {
  user: {
    name: 'test-fns',
    email: 'test-fns@test.local',
  },
  commits: {
    init: true,
    fixture: true,
  },
};
```

### asExplicitGitOptions helper

```ts
const asExplicitGitOptions = (git: boolean | GitOptions | undefined) => {
  if (!git) return null;
  if (git === true) return GIT_DEFAULTS;
  return {
    user: { ...GIT_DEFAULTS.user, ...git.user },
    commits: { ...GIT_DEFAULTS.commits, ...git.commits },
  };
};
```

### hasContent check

```ts
// check if clone or symlinks added content
const hasContent = !!(input.clone || input.symlink?.length);
```

### execSync options

```ts
execSync(cmd, {
  cwd: tempDir,
  stdio: 'pipe', // suppress output
});
```

---

## readme documentation additions

add new section after symlink examples:

```md
**with git initialization:**

\`\`\`ts
import { genTempDir } from 'test-fns';

describe('git status helper', () => {
  given('a git repo with committed baseline', () => {
    const testDir = genTempDir({
      slug: 'git-status-test',
      clone: './src/__fixtures__/project',
      git: true,
    });

    when('a file is modified', () => {
      fs.appendFileSync(path.join(testDir, 'config.json'), '\n// comment');

      then('git diff detects the change', () => {
        const diff = execSync('git diff', { cwd: testDir }).toString();
        expect(diff).toContain('+// comment');
      });
    });
  });
});
\`\`\`

git options:
- `git: true` — init repo, commit 'began', clone/symlink, commit 'fixture'
- `git: { commits: { init: false } }` — init repo only, no commits
- `git: { commits: { fixture: false } }` — commit 'began' only, leave clone/symlink uncommitted

notes:
- repo-local git config is set (ci-safe, no global config needed)
- 'began' commit is empty (created before clone/symlinks)
- 'fixture' commit contains all clone/symlink content
- if no clone/symlink provided, only 'began' commit is created
```

---

## risks and mitigations

| risk | mitigation |
|------|------------|
| git not installed on system | let execSync throw — clear error message |
| slow on large fixtures | git add/commit is fast for typical test fixtures |
| git version differences | use only basic commands (init, config, add, commit) |
| branch name varies by git version | accept default; don't force 'main' |

---

## summary

- **2 new infra files**: `initGitRepo.ts`, `commitGitChanges.ts`
- **2 new integration test files**: for the above
- **3 modified files**: `genTempDir.ts`, `genEphemeralTempDir.ts`, `readme.md`
- **1 extended test file**: `genTempDir.acceptance.jest.test.ts`
- **pit-of-success defaults**: `git: true` does the correct action (init + config + commits)
- **escape hatches**: `commits.init`, `commits.fixture` for edge cases
