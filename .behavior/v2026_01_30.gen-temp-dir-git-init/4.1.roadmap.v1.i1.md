# roadmap: genTempDir git initialization

## phase 0: infra — git helpers

**prereqs**: read blueprint `.behavior/v2026_01_30.gen-temp-dir-git-init/3.3.blueprint.v1.i1.md`

### 0.1 create `initGitRepo.ts`

- [ ] create `src/infra/isomorph.fs/initGitRepo.ts`
- [ ] implement: `git init` + `git config user.name` + `git config user.email`
- [ ] use `execSync` with `{ cwd, stdio: 'pipe' }`
- [ ] default user: `test-fns` / `test-fns@test.local`

**acceptance criteria:**
- dir becomes a valid git repo (`git rev-parse --git-dir` succeeds)
- `git config user.name` returns `test-fns`
- `git config user.email` returns `test-fns@test.local`

**verify:**
```sh
npm run test:integration -- initGitRepo
```

### 0.2 create `initGitRepo.integration.jest.test.ts`

- [ ] create `src/infra/isomorph.fs/initGitRepo.integration.jest.test.ts`
- [ ] case: creates valid git repo
- [ ] case: sets repo-local user.name
- [ ] case: sets repo-local user.email
- [ ] case: works without global git config (ci-safe)

**verify:**
```sh
npm run test:integration -- initGitRepo
```

### 0.3 create `commitGitChanges.ts`

- [ ] create `src/infra/isomorph.fs/commitGitChanges.ts`
- [ ] implement: `git add .` + `git commit -m {message}`
- [ ] support `allowEmpty` option for `--allow-empty` flag
- [ ] use `execSync` with `{ cwd, stdio: 'pipe' }`

**acceptance criteria:**
- staged files are committed
- commit message matches input
- `allowEmpty: true` creates commit even with no changes

**verify:**
```sh
npm run test:integration -- commitGitChanges
```

### 0.4 create `commitGitChanges.integration.jest.test.ts`

- [ ] create `src/infra/isomorph.fs/commitGitChanges.integration.jest.test.ts`
- [ ] case: commits staged files with correct message
- [ ] case: `allowEmpty: true` creates empty commit
- [ ] case: `allowEmpty: false` (default) fails on empty

**verify:**
```sh
npm run test:integration -- commitGitChanges
```

### phase 0 gate

```sh
npm run test:integration -- initGitRepo commitGitChanges
```

all tests pass → proceed to phase 1

---

## phase 1: wire — genEphemeralTempDir

**prereqs**: phase 0 complete

### 1.1 update `genEphemeralTempDir.ts`

- [ ] add `git` to input type
- [ ] import `initGitRepo` and `commitGitChanges`
- [ ] add `asExplicitGitOptions` helper (or inline)
- [ ] after `fs.mkdirSync`: call `initGitRepo` if git enabled
- [ ] after `initGitRepo`: call `commitGitChanges('began')` if `commits.init`
- [ ] after clone/symlinks: call `commitGitChanges('fixture')` if `commits.fixture` && hasContent

**acceptance criteria:**
- `git: true` → repo init + 'began' commit + 'fixture' commit (if content)
- `git: { commits: { init: false } }` → repo init only
- `git: { commits: { fixture: false } }` → repo init + 'began' only
- `git: undefined` → no git operations (prior behavior)

**verify:**
```sh
npm run test:integration -- genEphemeralTempDir
```

### 1.2 update `genEphemeralTempDir.integration.jest.test.ts`

- [ ] add case: `git: true` creates valid git repo
- [ ] add case: `git: true` creates 'began' commit
- [ ] add case: `git: true` + clone creates 'fixture' commit
- [ ] add case: `git: { commits: { init: false } }` has no commits
- [ ] add case: `git: { commits: { fixture: false } }` has only 'began'

**verify:**
```sh
npm run test:integration -- genEphemeralTempDir
```

### phase 1 gate

```sh
npm run test:integration -- genEphemeralTempDir
```

all tests pass → proceed to phase 2

---

## phase 2: contract — genTempDir

**prereqs**: phase 1 complete

### 2.1 update `genTempDir.ts`

- [ ] add `git` to input type (same shape as genEphemeralTempDir)
- [ ] pass `git` through to `genEphemeralTempDir`
- [ ] update jsdoc with git examples

**acceptance criteria:**
- `genTempDir({ slug, git: true })` returns git-initialized temp dir
- type signature includes `git?: boolean | { commits?: { init?: boolean; fixture?: boolean } }`

**verify:**
```sh
npm run test:types
npm run test:integration -- genTempDir
```

### phase 2 gate

```sh
npm run test:types && npm run test:integration -- genTempDir
```

all pass → proceed to phase 3

---

## phase 3: acceptance — blackbox tests

**prereqs**: phase 2 complete

### 3.1 update `genTempDir.acceptance.jest.test.ts`

- [ ] add `[case8] git: true` — valid git repo, 'began' commit exists
- [ ] add `[case8] git: true + clone` — 'began' then 'fixture', clean work tree
- [ ] add `[case9] git: { commits: { init: false } }` — repo but no commits
- [ ] add `[case10] git: { commits: { fixture: false } }` — 'began' only, files uncommitted
- [ ] add `[case11] git: true, no clone/symlink` — only 'began' (no 'fixture')

**acceptance criteria:**
- all cases verify blackbox behavior via contract imports only
- git operations verified via `execSync('git ...')` in assertions

**verify:**
```sh
npm run test:acceptance -- genTempDir
```

### phase 3 gate

```sh
npm run test:acceptance -- genTempDir
```

all pass → proceed to phase 4

---

## phase 4: docs — readme + jsdoc

**prereqs**: phase 3 complete

### 4.1 update `readme.md`

- [ ] add "with git initialization" section after symlink examples
- [ ] document `git: true` usage
- [ ] document `git: { commits: { init, fixture } }` options
- [ ] document ci-safe behavior (repo-local config)
- [ ] document commit message semantics ('began', 'fixture')

**acceptance criteria:**
- readme shows complete example
- all git options documented
- notes section explains behavior

**verify:**
```sh
# manual review of readme.md
```

### 4.2 update jsdoc in `genTempDir.ts`

- [ ] add `@example` for `git: true`
- [ ] add `@example` for `git: { commits: { fixture: false } }`
- [ ] add `@note` about ci-safe config

**verify:**
```sh
npm run test:types
```

### phase 4 gate

```sh
npm run test:types && npm run test
```

all pass → feature complete

---

## final verification

```sh
# full test suite
npm run test

# type check
npm run test:types

# lint
npm run test:lint
```

all green → ready for commit

---

## summary checklist

| phase | deliverable | gate |
|-------|-------------|------|
| 0 | `initGitRepo.ts` + tests | `npm run test:integration -- initGitRepo` |
| 0 | `commitGitChanges.ts` + tests | `npm run test:integration -- commitGitChanges` |
| 1 | `genEphemeralTempDir.ts` wire-up | `npm run test:integration -- genEphemeralTempDir` |
| 2 | `genTempDir.ts` contract | `npm run test:types && npm run test:integration -- genTempDir` |
| 3 | acceptance tests | `npm run test:acceptance -- genTempDir` |
| 4 | readme + jsdoc | `npm run test` |
