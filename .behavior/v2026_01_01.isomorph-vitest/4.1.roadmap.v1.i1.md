# roadmap: vitest + jest isomorphism

## wish recap

> support vitest and jest isomorphically, based on whichever is currently invoking the code that these utils are imported from
>
> it should be invisible to the user of this lib

---

## dependency graph

```
phase 1: infra foundation
  ├── 1.1 getRequire (no deps)
  └── 1.2 detectTestRunner (no deps)
        └── 1.3 getTestGlobals (depends: 1.1, 1.2)
              └── 1.4 runTest (depends: 1.2, 1.3)

phase 2: domain operations
  ├── 2.1 move files to domain.operations (depends: 1.*)
  ├── 2.2 modify givenWhenThen (depends: 1.3, 1.4)
  ├── 2.3 modify usePrep (depends: 1.3)
  └── 2.4 contract/index.ts (depends: 2.1, 2.2, 2.3)

phase 3: vitest infrastructure
  ├── 3.1 add dependencies (no deps)
  ├── 3.2 vitest.config.ts (depends: 3.1)
  ├── 3.3 jest.config.ts update (no deps)
  └── 3.4 npm scripts (depends: 3.2, 3.3)

phase 4: vitest tests
  └── 4.* (depends: phase 3)

phase 5: acceptance tests
  └── 5.* (depends: phase 4)

phase 6: documentation
  └── 6.* (depends: phase 5)
```

---

## phase 1: infrastructure layer

### 1.1 getRequire

- [ ] **create** `src/infra/isomorph.node/getRequire.ts`

  **acceptance criteria**:
  - exports `req` as a `NodeRequire` function
  - works in CJS context (returns global `require`)
  - works in ESM context (uses `createRequire(import.meta.url)`)

  **verification**:
  ```sh
  npm run test:types  # no type errors
  ```

- [ ] **create** `src/infra/isomorph.node/getRequire.jest.test.ts`

  **acceptance criteria**:
  - `req` is defined and callable
  - `req('path')` returns the path module
  - `req('node:module')` returns the module module

  **verification**:
  ```sh
  npm run test:unit -- getRequire.jest.test.ts
  # expect: all tests pass
  ```

---

### 1.2 detectTestRunner

- [ ] **create** `src/infra/isomorph.test/detectTestRunner.ts`

  **acceptance criteria**:
  - exports `TestRunner` type as `'vitest' | 'jest'`
  - exports `detectTestRunner()` that checks env vars
  - exports `getTestRunner()` with cached result
  - throws `UnexpectedCodePathError` when neither runner detected
  - vitest takes precedence when both env vars present

  **verification**:
  ```sh
  npm run test:types  # no type errors
  ```

- [ ] **create** `src/infra/isomorph.test/detectTestRunner.jest.test.ts`

  **acceptance criteria**:
  - returns `'jest'` when `JEST_WORKER_ID` is set
  - returns `'vitest'` when `VITEST` is set
  - returns `'vitest'` when both are set (vitest precedence)
  - throws when neither is set
  - caches result on subsequent calls

  **verification**:
  ```sh
  npm run test:unit -- detectTestRunner.jest.test.ts
  # expect: all tests pass
  ```

---

### 1.3 getTestGlobals

**depends on**: 1.1, 1.2

- [ ] **create** `src/infra/isomorph.test/getTestGlobals.ts`

  **acceptance criteria**:
  - exports `TestGlobals` interface with describe, test, beforeAll, beforeEach, afterAll, afterEach
  - exports `getTestGlobals()` that requires from active runner
  - exports `globals()` as cached accessor
  - vitest: requires from `vitest`
  - jest: requires from `@jest/globals`

  **verification**:
  ```sh
  npm run test:types  # no type errors
  ```

- [ ] **create** `src/infra/isomorph.test/getTestGlobals.jest.test.ts`

  **acceptance criteria**:
  - `globals().describe` is a function
  - `globals().test` is a function
  - `globals().beforeAll` is a function
  - `globals().beforeEach` is a function
  - cache returns same reference on subsequent calls

  **verification**:
  ```sh
  npm run test:unit -- getTestGlobals.jest.test.ts
  # expect: all tests pass
  ```

---

### 1.4 runTest

**depends on**: 1.2, 1.3

- [ ] **create** `src/infra/isomorph.test/runTest.ts`

  **acceptance criteria**:
  - exports `TestOptions` interface with optional `retry` number
  - exports `runTest({ name, fn, options? })` that handles retry per-runner
  - exports `runTestOnly`, `runTestSkip` variants
  - jest: calls `jest.retryTimes(n)` before `test()`
  - vitest: calls `test(name, { retry: n }, fn)`

  **verification**:
  ```sh
  npm run test:types  # no type errors
  ```

- [ ] **create** `src/infra/isomorph.test/runTest.jest.test.ts`

  **acceptance criteria**:
  - `runTest` without retry calls standard `test()`
  - `runTest` with retry calls `jest.retryTimes()` then `test()`
  - `runTestOnly` uses `test.only()`
  - `runTestSkip` uses `test.skip()`

  **verification**:
  ```sh
  npm run test:unit -- runTest.jest.test.ts
  # expect: all tests pass
  ```

---

## phase 2: domain operations + contract

**depends on**: phase 1 complete

### 2.1 restructure files

- [ ] **move** existing source files to `src/domain.operations/`
  - `givenWhenThen.ts` → `src/domain.operations/givenWhenThen.ts`
  - `usePrep.ts` → `src/domain.operations/usePrep.ts`
  - `genTestUuid.ts` → `src/domain.operations/genTestUuid.ts`

- [ ] **rename** test files to `.jest.test.ts`
  - `*.test.ts` → `*.jest.test.ts`

  **acceptance criteria**:
  - all files moved to new locations
  - imports updated to reflect new paths
  - no broken imports

  **verification**:
  ```sh
  npm run test:types  # no type errors
  npm run test:unit   # all tests pass
  ```

---

### 2.2 modify givenWhenThen

**depends on**: 1.3, 1.4, 2.1

- [ ] **modify** `src/domain.operations/givenWhenThen.ts`

  **changes**:
  - import `globals` from `@src/infra/isomorph.test/getTestGlobals`
  - import `runTest` from `@src/infra/isomorph.test/runTest`
  - replace direct `describe`/`test` usage with `globals().describe`/`globals().test`
  - replace `jest.retryTimes()` + `test()` with `runTest({ ..., options: { retry } })`

  **acceptance criteria**:
  - no direct references to jest globals
  - no direct references to vitest globals
  - `then.repeatably` uses `runTest` with retry option

  **verification**:
  ```sh
  npm run test:types  # no type errors
  npm run test:unit -- givenWhenThen.jest.test.ts
  # expect: all existing tests pass
  ```

---

### 2.3 modify usePrep

**depends on**: 1.3, 2.1

- [ ] **modify** `src/domain.operations/usePrep.ts`

  **changes**:
  - import `globals` from `@src/infra/isomorph.test/getTestGlobals`
  - replace direct `beforeAll`/`beforeEach` with `globals().beforeAll`/`globals().beforeEach`

  **acceptance criteria**:
  - no direct references to jest globals
  - no direct references to vitest globals

  **verification**:
  ```sh
  npm run test:types  # no type errors
  npm run test:unit -- usePrep.jest.test.ts
  # expect: all existing tests pass
  ```

---

### 2.4 contract layer

**depends on**: 2.2, 2.3

- [ ] **create** `src/contract/index.ts`

  **exports**:
  - `given`, `when`, `then` from domain.operations/givenWhenThen
  - `usePrep`, `useBeforeAll`, `useBeforeEach` from domain.operations/usePrep
  - `genTestUuid` from domain.operations/genTestUuid

- [ ] **update** `src/index.ts`

  **changes**:
  - re-export everything from `@src/contract/index`

  **acceptance criteria**:
  - public api unchanged
  - consumers can import from `test-fns` as before

  **verification**:
  ```sh
  npm run test:types  # no type errors
  npm run test:unit   # all tests pass
  ```

---

## phase 3: vitest infrastructure

### 3.1 add dependencies

- [ ] **add** `vitest` to devDependencies

  ```sh
  npm install --save-dev vitest
  ```

- [ ] **add** `@jest/globals` to devDependencies (if not present)

  ```sh
  npm install --save-dev @jest/globals
  ```

- [ ] **add** peer dependencies to package.json

  ```json
  {
    "peerDependencies": {
      "vitest": ">=1.0.0",
      "jest": ">=29.0.0"
    },
    "peerDependenciesMeta": {
      "vitest": { "optional": true },
      "jest": { "optional": true }
    }
  }
  ```

  **verification**:
  ```sh
  npm install  # no errors
  npm run test:types  # no type errors
  ```

---

### 3.2 vitest config

**depends on**: 3.1

- [ ] **create** `vitest.config.ts`

  ```ts
  import { defineConfig } from 'vitest/config';

  export default defineConfig({
    test: {
      include: ['src/**/*.vitest.test.ts'],
    },
  });
  ```

  **acceptance criteria**:
  - only matches `*.vitest.test.ts` files
  - no `globals: true` (we import explicitly)

  **verification**:
  ```sh
  npx vitest --help  # vitest installed correctly
  ```

---

### 3.3 jest config update

- [ ] **update** `jest.config.ts`

  **changes**:
  - set `testMatch` to `['**/*.jest.test.ts']`

  **acceptance criteria**:
  - only matches `*.jest.test.ts` files
  - excludes `*.vitest.test.ts` files

  **verification**:
  ```sh
  npx jest --listTests  # only lists .jest.test.ts files
  ```

---

### 3.4 npm scripts

**depends on**: 3.2, 3.3

- [ ] **add** npm scripts to package.json

  ```json
  {
    "scripts": {
      "test:jest": "jest",
      "test:vitest": "vitest run",
      "test:unit": "npm run test:jest && npm run test:vitest"
    }
  }
  ```

  **acceptance criteria**:
  - `test:jest` runs only jest tests
  - `test:vitest` runs only vitest tests
  - `test:unit` runs both

  **verification**:
  ```sh
  npm run test:jest    # runs jest tests
  npm run test:vitest  # runs vitest tests (may fail - no vitest tests yet)
  ```

---

## phase 4: vitest tests

**depends on**: phase 3 complete

### 4.1 infra vitest tests

- [ ] **create** `src/infra/isomorph.node/getRequire.vitest.test.ts`

  **acceptance criteria**:
  - `req` is defined and callable
  - `req('path')` returns the path module

  **verification**:
  ```sh
  npm run test:vitest -- getRequire.vitest.test.ts
  # expect: all tests pass
  ```

- [ ] **create** `src/infra/isomorph.test/detectTestRunner.vitest.test.ts`

  **acceptance criteria**:
  - returns `'vitest'` in vitest context
  - caches result

  **verification**:
  ```sh
  npm run test:vitest -- detectTestRunner.vitest.test.ts
  # expect: all tests pass
  ```

- [ ] **create** `src/infra/isomorph.test/getTestGlobals.vitest.test.ts`

  **acceptance criteria**:
  - `globals().describe` is a function
  - `globals().test` is a function
  - cache returns same reference

  **verification**:
  ```sh
  npm run test:vitest -- getTestGlobals.vitest.test.ts
  # expect: all tests pass
  ```

- [ ] **create** `src/infra/isomorph.test/runTest.vitest.test.ts`

  **acceptance criteria**:
  - `runTest` without retry calls standard `test()`
  - `runTest` with retry calls `test()` with `{ retry }` option

  **verification**:
  ```sh
  npm run test:vitest -- runTest.vitest.test.ts
  # expect: all tests pass
  ```

---

### 4.2 domain operations vitest tests

- [ ] **create** `src/domain.operations/givenWhenThen.vitest.test.ts`

  **acceptance criteria**:
  - `given()` creates describe block
  - `when()` creates describe block
  - `then()` creates test block
  - `.only`, `.skip`, `.todo` modifiers work
  - `.skipIf`, `.runIf` modifiers work
  - `then.repeatably` with criteria='EVERY' works
  - `then.repeatably` with criteria='SOME' works

  **verification**:
  ```sh
  npm run test:vitest -- givenWhenThen.vitest.test.ts
  # expect: all tests pass
  ```

- [ ] **create** `src/domain.operations/usePrep.vitest.test.ts`

  **acceptance criteria**:
  - `usePrep` with mode='beforeAll' runs once
  - `usePrep` with mode='beforeEach' runs before each test
  - `useBeforeAll` convenience wrapper works
  - `useBeforeEach` convenience wrapper works

  **verification**:
  ```sh
  npm run test:vitest -- usePrep.vitest.test.ts
  # expect: all tests pass
  ```

---

## phase 5: acceptance tests

**depends on**: phase 4 complete

### 5.1 jest acceptance tests

- [ ] **create** `src/__acceptance__/isomorphism.jest.acceptance.test.ts`

  **acceptance criteria (blackbox)**:
  - import `{ given, when, then, usePrep }` from `test-fns`
  - all exports work correctly in jest context
  - `then.repeatably` with `criteria='SOME'` retries correctly

  **verification**:
  ```sh
  npm run test:jest -- isomorphism.jest.acceptance.test.ts
  # expect: all tests pass
  ```

---

### 5.2 vitest acceptance tests

- [ ] **create** `src/__acceptance__/isomorphism.vitest.acceptance.test.ts`

  **acceptance criteria (blackbox)**:
  - import `{ given, when, then, usePrep }` from `test-fns`
  - all exports work correctly in vitest context
  - `then.repeatably` with `criteria='SOME'` retries correctly

  **verification**:
  ```sh
  npm run test:vitest -- isomorphism.vitest.acceptance.test.ts
  # expect: all tests pass
  ```

---

## phase 6: documentation

**depends on**: phase 5 complete

### 6.1 readme update

- [ ] **update** README.md

  **additions**:
  - vitest compatibility section
  - note about optional peer dependencies
  - example vitest.config.ts for consumers

  **acceptance criteria**:
  - clear documentation for both jest and vitest usage
  - no breaking changes to existing documentation

  **verification**:
  ```sh
  # manual review of README
  ```

---

## final verification

- [ ] **run** full test suite

  ```sh
  npm run test:types
  npm run test:lint
  npm run test:unit
  npm run build
  ```

  **acceptance criteria**:
  - zero type errors
  - zero lint errors
  - all jest tests pass
  - all vitest tests pass
  - build succeeds

---

## success criteria checklist

- [ ] existing jest tests pass unchanged
- [ ] new vitest tests pass
- [ ] user code requires zero changes
- [ ] detection is automatic and invisible
- [ ] clear error messages when neither runner detected
- [ ] `then.repeatably` works in both runners
- [ ] `usePrep` works in both runners
- [ ] documentation updated
