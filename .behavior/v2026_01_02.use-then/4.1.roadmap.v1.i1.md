# roadmap: useThen and useWhen implementation

## phase 1: useThen core implementation

### step 1.1: implement useThen.ts
- [ ] create `src/domain.operations/useThen.ts`
- [ ] implement `createUseThenProxy` helper
- [ ] implement `useThen` main function
- [ ] implement modifiers: `.only`, `.skip`, `.skipIf`, `.runIf`

**acceptance criteria:**
```
given('useThen implementation')
  then('file exists at src/domain.operations/useThen.ts')
  then('exports useThen function')
  then('exports useThen.only modifier')
  then('exports useThen.skip modifier')
  then('exports useThen.skipIf modifier')
  then('exports useThen.runIf modifier')
```

**verification:**
```sh
npm run test:types
```

---

### step 1.2: add useThen jest integration test
- [ ] create `src/domain.operations/useThen.jest.test.ts`
- [ ] test: registers test with correct "then:" prefix
- [ ] test: return value accessible in subsequent then blocks
- [ ] test: proxy throws on premature access
- [ ] test: async function support
- [ ] test: modifiers work correctly

**acceptance criteria:**
```
given('useThen jest tests')
  when('tests run under jest')
    then('useThen registers test with "then: {desc}" name')
    then('return value is accessible after test runs')
    then('proxy throws UnexpectedCodePathError before test runs')
    then('async functions resolve correctly')
    then('useThen.skip skips the test')
```

**verification:**
```sh
npm run test:unit -- useThen.jest.test.ts
```

---

### step 1.3: add useThen vitest integration test
- [ ] create `src/domain.operations/useThen.vitest.test.ts`
- [ ] test: registers test with correct "then:" prefix
- [ ] test: return value accessible in subsequent then blocks
- [ ] test: proxy throws on premature access
- [ ] test: async function support
- [ ] test: modifiers work correctly

**acceptance criteria:**
```
given('useThen vitest tests')
  when('tests run under vitest')
    then('useThen registers test with "then: {desc}" name')
    then('return value is accessible after test runs')
    then('proxy throws UnexpectedCodePathError before test runs')
    then('async functions resolve correctly')
    then('useThen.skip skips the test')
```

**verification:**
```sh
npm run test:unit:vitest -- useThen.vitest.test.ts
```

---

## phase 2: useWhen core implementation

**depends on:** phase 1 complete

### step 2.1: implement useWhen.ts
- [ ] create `src/domain.operations/useWhen.ts`
- [ ] implement `createUseWhen` helper
- [ ] implement `useWhen` main function
- [ ] implement modifiers: `.only`, `.skip`, `.skipIf`, `.runIf`

**acceptance criteria:**
```
given('useWhen implementation')
  then('file exists at src/domain.operations/useWhen.ts')
  then('exports useWhen function')
  then('exports useWhen.only modifier')
  then('exports useWhen.skip modifier')
  then('exports useWhen.skipIf modifier')
  then('exports useWhen.runIf modifier')
```

**verification:**
```sh
npm run test:types
```

---

### step 2.2: add useWhen jest integration test
- [ ] create `src/domain.operations/useWhen.jest.test.ts`
- [ ] test: registers describe with correct "when:" prefix
- [ ] test: return value accessible in sibling when blocks
- [ ] test: callback executes synchronously
- [ ] test: modifiers work correctly

**acceptance criteria:**
```
given('useWhen jest tests')
  when('tests run under jest')
    then('useWhen registers describe with "when: {desc}" name')
    then('return value is accessible in sibling when blocks')
    then('callback executes synchronously at registration time')
    then('useWhen.skip skips the describe block')
```

**verification:**
```sh
npm run test:unit -- useWhen.jest.test.ts
```

---

### step 2.3: add useWhen vitest integration test
- [ ] create `src/domain.operations/useWhen.vitest.test.ts`
- [ ] test: registers describe with correct "when:" prefix
- [ ] test: return value accessible in sibling when blocks
- [ ] test: callback executes synchronously
- [ ] test: modifiers work correctly

**acceptance criteria:**
```
given('useWhen vitest tests')
  when('tests run under vitest')
    then('useWhen registers describe with "when: {desc}" name')
    then('return value is accessible in sibling when blocks')
    then('callback executes synchronously at registration time')
    then('useWhen.skip skips the describe block')
```

**verification:**
```sh
npm run test:unit:vitest -- useWhen.vitest.test.ts
```

---

## phase 3: public contract exports

**depends on:** phase 1 + phase 2 complete

### step 3.1: update src/contract/index.ts
- [ ] add export for `useThen`
- [ ] add export for `useWhen`

**acceptance criteria:**
```
given('contract exports')
  then('useThen is exported from test-fns')
  then('useWhen is exported from test-fns')
```

**verification:**
```sh
npm run test:types
```

---

### step 3.2: update bdd namespace in givenWhenThen.ts
- [ ] add `useThen` to bdd namespace
- [ ] add `useWhen` to bdd namespace

**acceptance criteria:**
```
given('bdd namespace')
  then('bdd.useThen is accessible')
  then('bdd.useWhen is accessible')
```

**verification:**
```sh
npm run test:types
```

---

## phase 4: acceptance tests

**depends on:** phase 3 complete

### step 4.1: add idempotency pattern acceptance test (jest)
- [ ] create acceptance test demonstrating full wish example
- [ ] test: t1 captures response via useThen
- [ ] test: t2 uses responseFirst from useWhen
- [ ] test: idempotency assertion passes

**acceptance criteria:**
```
given('idempotency pattern acceptance test - jest')
  when('full pattern is executed')
    then('responseFirst is captured in t1')
    then('responseFirst is accessible in t2')
    then('responseSecond can be compared to responseFirst')
```

**verification:**
```sh
npm run test:unit -- useThen.jest.test.ts
# (acceptance test included in same file or separate)
```

---

### step 4.2: add idempotency pattern acceptance test (vitest)
- [ ] create acceptance test demonstrating full wish example
- [ ] test: t1 captures response via useThen
- [ ] test: t2 uses responseFirst from useWhen
- [ ] test: idempotency assertion passes

**acceptance criteria:**
```
given('idempotency pattern acceptance test - vitest')
  when('full pattern is executed')
    then('responseFirst is captured in t1')
    then('responseFirst is accessible in t2')
    then('responseSecond can be compared to responseFirst')
```

**verification:**
```sh
npm run test:unit:vitest -- useThen.vitest.test.ts
```

---

## phase 5: documentation

**depends on:** phase 4 complete

### step 5.1: update readme.md
- [ ] add useThen section with example
- [ ] add useWhen section with example
- [ ] add "when to use each" comparison table
- [ ] add "immutability: safer, simpler tests" section

**acceptance criteria:**
```
given('readme documentation')
  then('useThen usage example is documented')
  then('useWhen usage example is documented')
  then('comparison table explains when to use each hook')
  then('immutability benefits are explained')
```

**verification:**
```sh
# manual review of readme.md
```

---

## phase 6: final verification

**depends on:** all phases complete

### step 6.1: run full test suite
- [ ] run all jest tests
- [ ] run all vitest tests
- [ ] run type checks
- [ ] run lint checks

**acceptance criteria:**
```
given('full test suite')
  then('all jest tests pass')
  then('all vitest tests pass')
  then('type checks pass')
  then('lint checks pass')
```

**verification:**
```sh
npm run test:types
npm run test:lint
npm run test:unit
npm run test:unit:vitest
```

---

### step 6.2: verify blackbox criteria satisfaction
- [ ] usecase.1: share operation response across multiple then assertions ✓
- [ ] usecase.2: share operation response across multiple when blocks ✓
- [ ] usecase.3: verify idempotency pattern ✓
- [ ] usecase.4: isomorphic test runner support ✓
- [ ] usecase.5: primitive and object return values ✓

**acceptance criteria:**
```
given('blackbox criteria')
  then('usecase.1 is satisfied by useThen tests')
  then('usecase.2 is satisfied by useWhen tests')
  then('usecase.3 is satisfied by idempotency acceptance test')
  then('usecase.4 is satisfied by jest + vitest test suites')
  then('usecase.5 is satisfied by object return value tests')
```

**verification:**
```sh
# review test output for all usecases covered
npm run test
```

---

## dependency graph

```
phase 1: useThen
  step 1.1 (implement)
    └── step 1.2 (jest test) ─┐
    └── step 1.3 (vitest test) ┘
                               │
phase 2: useWhen ──────────────┤
  step 2.1 (implement)         │
    └── step 2.2 (jest test) ──┤
    └── step 2.3 (vitest test) ┘
                               │
phase 3: exports ──────────────┤
  step 3.1 (contract/index.ts) │
  step 3.2 (bdd namespace) ────┘
                               │
phase 4: acceptance ───────────┤
  step 4.1 (jest acceptance)   │
  step 4.2 (vitest acceptance) ┘
                               │
phase 5: docs ─────────────────┤
  step 5.1 (readme update) ────┘
                               │
phase 6: verification ─────────┘
  step 6.1 (full test suite)
  step 6.2 (blackbox criteria)
```

## execution summary

| phase | steps | estimated effort |
|-------|-------|------------------|
| 1. useThen core | 3 | medium |
| 2. useWhen core | 3 | medium |
| 3. exports | 2 | small |
| 4. acceptance | 2 | small |
| 5. docs | 1 | small |
| 6. verification | 2 | small |
| **total** | **13** | |
