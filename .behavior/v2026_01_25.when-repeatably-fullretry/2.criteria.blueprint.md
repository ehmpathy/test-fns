# blueprint criteria: repeatably with criteria 'SOME'

## blackbox criteria satisfied

- core model: N describe blocks registered, skip subsequent on success ✓
- usecase.1: when.repeatably registers N identical when blocks ✓
- usecase.2: given.repeatably registers N identical given blocks ✓
- usecase.3: skip behavior applies to all* hooks and tests ✓
- usecase.4: test output reflects skip state ✓
- edge cases: attempts=1, nested blocks, mixed pass/fail ✓

## subcomponent contracts

```ts
given('genDescribeRepeatable contract')
  then('exposes: (describeFn, config) => (desc, fn) => void')
  then('config contains: { attempts: number, criteria: "EVERY" | "SOME" }')
  then('registers N describe blocks named "{desc}, attempt {N}"')
  then('provides RepeatableContext to user callback: { getAttempt: () => number }')

given('registryDescribeRepeatable contract')
  then('exposes: { current: RepeatableContextRef | null }')
  then('current is set at describe callback registration')
  then('current is cleared after describe callback completes')
  then('RepeatableContextRef exposes: { hasSucceeded: () => boolean }')

given('useBeforeAll contract (extended)')
  then('captures registryDescribeRepeatable.current at registration time')
  then('checks captured context.hasSucceeded() at execution time')
  then('skips callback execution if hasSucceeded() returns true')
  then('returns proxy that defers access until execution')

given('useAfterAll contract (extended)')
  then('captures registryDescribeRepeatable.current at registration time')
  then('checks captured context.hasSucceeded() at execution time')
  then('skips callback execution if hasSucceeded() returns true')

given('success state tracker contract')
  then('tracks whether any attempt in this repeatably block has passed')
  then('marks success in afterAll when attempt completes without failures')
  then('exposes hasSucceeded() that returns current state')
```

note: `useThen` does not need special treatment — it creates a test block, which is automatically skipped via the test skip mechanism

## composition boundaries

```ts
given('genDescribeRepeatable composition')
  then('creates scoped success state per repeatably block')
  then('exposes success state via registryDescribeRepeatable.current')
  then('triggers test skip when hasSucceeded() is true')
  then('tracks failures within each attempt')
  then('marks success after attempt completes without failures')

given('hook skip composition')
  then('useBeforeAll, useAfterAll capture context at registration')
  then('both check hasSucceeded() at execution time via captured reference')
  then('captured reference points to function, not value (reads mutable state)')

given('test skip composition')
  then('tests are skipped when hasSucceeded() returns true')
  then('skipped tests do not execute their callbacks')
```

## integration boundaries

```ts
given('vitest integration')
  then('vitest is optional peerDependency: ">=3.1.0"')
  then('test skip mechanism compatible with vitest 3.1+')
  then('failure detection compatible with vitest test context')

given('jest integration')
  then('jest is optional peerDependency')
  then('test skip mechanism compatible with jest')
  then('failure detection compatible with jest state')
  then('no config required')

given('framework-agnostic boundary')
  then('registration-time context capture works in both frameworks')
  then('describe callback synchronous execution is guaranteed by both')
  then('beforeAll/afterAll limitation applies to both frameworks')
```

## test coverage criteria

```ts
given('repeatably with criteria SOME')
  then('has unit tests for genDescribeRepeatable')
  then('has unit tests for registration-time context capture')
  then('has integration test: attempt 1 passes → attempts 2,3 skipped')
  then('has integration test: attempt 1 fails, attempt 2 passes → attempt 3 skipped')
  then('has integration test: all attempts fail')
  then('has integration test: useBeforeAll skipped on success')
  then('has integration test: useThen skipped on success')
  then('has integration test: nested repeatably blocks')
  then('has vitest-specific test suite')
  then('has jest-specific test suite')
```
